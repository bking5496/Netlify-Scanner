<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563EB">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Stock Scanner</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%232563EB'/><path d='M25 30h10v40H25zM40 30h5v40h-5zM50 30h10v40H50zM65 30h5v40h-5zM75 30h5v40h-5z' fill='white'/></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%232563EB'/><path d='M25 30h10v40H25zM40 30h5v40h-5zM50 30h10v40H50zM65 30h5v40h-5zM75 30h5v40h-5z' fill='white'/></svg>">
    <!-- Preconnect to CDNs for faster loading -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://exltxjvzsefmaxlgxyio.supabase.co">
    <!-- Critical CSS inline, external scripts deferred where possible -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <!-- XLSX loaded async - only needed for import/export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" async></script>
    <style>
        /* Critical CSS - inline for faster first paint */
        * { box-sizing: border-box; }
        body { margin: 0; }
        
        /* iOS camera fixes */
        #scanner video {
            object-fit: cover !important;
            width: 100% !important;
            height: 100% !important;
        }
        #scanner {
            overflow: hidden;
            border-radius: 12px;
        }
        
        /* Responsive adjustments */
        @media (min-width: 768px) {
            /* Tablet and desktop: better spacing */
            .scan-list-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
        }
        @media (min-width: 1024px) {
            /* Desktop: 3 column grid for scan items */
            .scan-list-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* Better touch targets on mobile */
        @media (max-width: 640px) {
            button, input, select {
                min-height: 44px;
            }
        }
        
        /* Desktop hover effects */
        @media (hover: hover) {
            .hover-lift:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px -5px rgb(0 0 0 / 0.1);
            }
        }
        
        /* Larger screens: increase max width of app container */
        @media (min-width: 1280px) {
            #app {
                max-width: 72rem; /* xl:max-w-6xl equivalent */
            }
        }
        
        @media (min-width: 1024px) {
            #app {
                max-width: 64rem; /* lg:max-w-5xl equivalent */
            }
        }
        
        /* Performance: GPU acceleration for animated elements */
        .animate-pulse, .animate-spin, .hover-lift, #scanner video {
            will-change: transform;
            transform: translateZ(0);
        }
        
        /* Reduce paint on scroll */
        #app {
            contain: layout style;
        }
        
        /* Smooth animations */
        .animate-fade-in {
            animation: fadeIn 0.15s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 min-h-screen font-sans antialiased selection:bg-blue-100 selection:text-blue-700">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <div id="app" class="max-w-4xl mx-auto min-h-screen bg-white shadow-2xl shadow-slate-200 overflow-hidden relative"></div>
    <div id="modal-root" class="relative z-50"></div>

    <script>
        // ===========================================
        // DATABASE CONFIGURATION
        // ===========================================
        // Detect hosting environment
        const isNetlify = window.location.hostname.includes('netlify.app') || window.location.hostname.includes('netlify.com');
        const isGitHubPages = window.location.hostname.includes('github.io');
        
        // Supabase Configuration (for GitHub Pages)
        // TODO: Replace these with your Supabase project credentials
        const SUPABASE_URL = 'https://exltxjvzsefmaxlgxyio.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4bHR4anZ6c2VmbWF4bGd4eWlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0NTQ2MjcsImV4cCI6MjA4MDAzMDYyN30.kc5RFVrN5orQ7AqPd51ot-sK1xbWsy_58ToowCvYhZw';
        const HEARTBEAT_INTERVAL_MS = 15000;
        const HEARTBEAT_GRACE_MS = 45000;
        
        const SUPABASE_PLACEHOLDER_URL = 'https://YOUR_PROJECT_ID.supabase.co';
        const SUPABASE_PLACEHOLDER_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const supabaseCredentialsConfigured = Boolean(window.supabase?.createClient)
            && Boolean(SUPABASE_URL)
            && Boolean(SUPABASE_ANON_KEY)
            && SUPABASE_URL !== SUPABASE_PLACEHOLDER_URL
            && !SUPABASE_URL.includes('YOUR_PROJECT_ID')
            && SUPABASE_ANON_KEY !== SUPABASE_PLACEHOLDER_KEY
            && !SUPABASE_ANON_KEY.includes('YOUR_SUPABASE_ANON_KEY');

        // Initialize Supabase client whenever credentials exist
        let supabase = null;
        if (supabaseCredentialsConfigured) {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            try {
                const cachedSession = JSON.parse(localStorage.getItem('supabaseSessionCache') || 'null');
                if (cachedSession?.access_token && cachedSession?.refresh_token) {
                    supabase.auth.setSession({
                        access_token: cachedSession.access_token,
                        refresh_token: cachedSession.refresh_token
                    }).catch(() => localStorage.removeItem('supabaseSessionCache'));
                }
                supabase.auth.onAuthStateChange((_event, session) => {
                    if (session?.access_token && session?.refresh_token) {
                        localStorage.setItem('supabaseSessionCache', JSON.stringify({
                            access_token: session.access_token,
                            refresh_token: session.refresh_token,
                            expires_at: session.expires_at
                        }));
                    }
                });
            } catch (err) {
                console.warn('Supabase session cache error', err);
            }
        }

        // Database helper - uses Netlify Functions OR Supabase OR localStorage
        const db = {
            connected: false,
            mode: 'localStorage', // 'netlify', 'supabase', or 'localStorage'
            
            async init() {
                // Try Netlify Functions first (if on Netlify)
                if (isNetlify) {
                    try {
                        const response = await fetch('/.netlify/functions/db', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'init' })
                        });
                        if (response.ok) {
                            this.connected = true;
                            this.mode = 'netlify';
                            console.log('Connected to Neon DB via Netlify Functions');
                            return true;
                        }
                    } catch (err) {
                        console.log('Netlify Functions not available:', err.message);
                    }
                }
                
                // Try Supabase (if on GitHub Pages and configured)
                if (supabase) {
                    try {
                        // Create tables if they don't exist (Supabase handles this via migrations)
                        // Just test the connection
                        const { error } = await supabase.from('stock_scans').select('id').limit(1);
                        if (!error || error.code === 'PGRST116') { // Table might be empty
                            this.connected = true;
                            this.mode = 'supabase';
                            console.log('Connected to Supabase');
                            return true;
                        }
                        console.log('Supabase error:', error);
                    } catch (err) {
                        console.log('Supabase not available:', err.message);
                    }
                }
                
                // Fallback to localStorage
                this.connected = false;
                this.mode = 'localStorage';
                console.log('Using localStorage for data storage');
                return false;
            },

            async insertStockTake(date) {
                if (this.mode === 'netlify') {
                    const response = await fetch('/.netlify/functions/db', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'insertStockTake', date })
                    });
                    return response.ok;
                }
                if (this.mode === 'supabase') {
                    const { error } = await supabase.from('stock_takes').upsert({ 
                        take_date: date, 
                        status: 'active' 
                    }, { onConflict: 'take_date' });
                    return !error;
                }
                return false;
            },
            
            async getStockScans(date) {
                if (this.mode === 'netlify') {
                    const response = await fetch('/.netlify/functions/db', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'getStockScans', date })
                    });
                    if (response.ok) {
                        const data = await response.json();
                        return data.rows || [];
                    }
                    return [];
                }
                if (this.mode === 'supabase') {
                    const { data, error } = await supabase
                        .from('stock_scans')
                        .select('*')
                        .eq('take_date', date)
                        .order('scanned_at', { ascending: false });
                    return error ? [] : data;
                }
                return [];
            },
            
            async insertStockScan(scan) {
                if (this.mode === 'netlify') {
                    const response = await fetch('/.netlify/functions/db', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'insertStockScan', scan })
                    });
                    return response.ok;
                }
                if (this.mode === 'supabase') {
                    const { error } = await supabase.from('stock_scans').insert({
                        take_date: scan.take_date,
                        batch_number: scan.batch_number,
                        pallet_number: scan.pallet_number,
                        cases_on_pallet: scan.cases_on_pallet,
                        actual_cases: scan.actual_cases,
                        stock_code: scan.stock_code,
                        description: scan.description,
                        raw_code: scan.raw_code,
                        device_id: scan.device_id,
                        scanned_by: scan.scanned_by || 'Unknown'
                    });
                    return !error;
                }
                return false;
            },
            
            async checkDuplicate(date, batchNumber, palletNumber) {
                if (this.mode === 'netlify') {
                    const response = await fetch('/.netlify/functions/db', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'checkDuplicate', date, batchNumber, palletNumber })
                    });
                    if (response.ok) {
                        const data = await response.json();
                        return data.duplicate || null;
                    }
                    return null;
                }
                if (this.mode === 'supabase') {
                    const { data, error } = await supabase
                        .from('stock_scans')
                        .select('*')
                        .eq('take_date', date)
                        .eq('batch_number', batchNumber)
                        .eq('pallet_number', palletNumber)
                        .limit(1)
                        .single();
                    return error ? null : data;
                }
                return null;
            },
            
            async deleteStockScan(id) {
                if (this.mode === 'netlify') {
                    const response = await fetch('/.netlify/functions/db', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'deleteStockScan', id })
                    });
                    return response.ok;
                }
                if (this.mode === 'supabase') {
                    const { error } = await supabase.from('stock_scans').delete().eq('id', id);
                    return !error;
                }
                return false;
            }
        };

        // Local storage fallback
        const localStorage_db = {
            get: (key) => {
                const value = localStorage.getItem(key);
                return value ? JSON.parse(value) : null;
            },
            set: (key, value) => {
                localStorage.setItem(key, JSON.stringify(value));
            },
            delete: (key) => {
                localStorage.removeItem(key);
            },
            list: (prefix) => {
                return Object.keys(localStorage)
                    .filter(k => k.startsWith(prefix))
                    .map(k => {
                        const val = localStorage.getItem(k);
                        return val ? JSON.parse(val) : null;
                    })
                    .filter(Boolean);
            }
        };

        const clearLocalScanStorage = () => {
            Object.keys(localStorage)
                .filter(key => key.startsWith('scan:'))
                .forEach(key => localStorage.removeItem(key));
        };

        // Product Database - loaded from Supabase or localStorage cache
        // FP = Finished Products (keyed by batchNumber)
        let productDatabase = JSON.parse(localStorage.getItem('productDatabase') || '{}');
        let productsLoadedFromDB = false;
        
        // RM = Raw Materials Database (keyed by stockCode)
        // Structure: { stockCode: { description, batches: { batchNumber: { expiryDates: [date1, date2, ...] } } } }
        // Multiple expiry dates are allowed per stock_code + batch_number combination
        let rawMaterialsDatabase = JSON.parse(localStorage.getItem('rawMaterialsDatabase') || '{}');
        let rmProductsLoadedFromDB = false;
        
        // Product Type Database - determines if product is ingredient (kg) or not (units)
        // Structure: { stockCodePrefix: { productType: 'Ingredient' | 'Non-Ingredient', unitType: 'kg' | 'units' } }
        // RM* products = Ingredient = kg
        // PM* products = Non-Ingredient = units
        let productTypeDatabase = JSON.parse(localStorage.getItem('productTypeDatabase') || '{}');
        let productTypesLoadedFromDB = false;

        // Load FP products from Supabase
        let _productsLoadPromise = null;
        async function loadProductsFromSupabase(forceReload = false) {
            // Return cached promise if already loading
            if (_productsLoadPromise && !forceReload) return _productsLoadPromise;
            
            // Skip if already loaded and not forcing reload
            if (productsLoadedFromDB && !forceReload) {
                return true;
            }
            
            if (!supabase) {
                console.log('Supabase not available, using cached products');
                return false;
            }
            
            _productsLoadPromise = (async () => {
                try {
                    console.log('Loading FP products from Supabase...');
                    const { data, error } = await supabase
                        .from('products')
                        .select('batch_number,stock_code,description'); // Only select needed fields
                    
                    if (error) {
                        console.error('Error loading products:', error);
                        return false;
                    }
                    
                    if (data && data.length > 0) {
                        // Convert array to object keyed by batch_number
                        productDatabase = {};
                        data.forEach(product => {
                            const batchNum = product.batch_number || product.BatchNumber || product.batchnumber;
                            const stockCode = product.stock_code || product.StockCode || product.stockcode;
                            const description = product.description || product.Description;
                            if (batchNum) {
                                productDatabase[batchNum] = { 
                                    stockCode: stockCode || '', 
                                    description: description || '' 
                                };
                            }
                        });
                        // Cache in localStorage for offline use
                        localStorage.setItem('productDatabase', JSON.stringify(productDatabase));
                        productsLoadedFromDB = true;
                        console.log(`Loaded ${Object.keys(productDatabase).length} FP products from Supabase`);
                        return true;
                    }
                    return false;
                } catch (err) {
                    console.error('Failed to load products from Supabase:', err);
                    return false;
                }
            })();
            
            return _productsLoadPromise;
        }
        
        // Load RM products from Supabase
        let _rmProductsLoadPromise = null;
        async function loadRawMaterialsFromSupabase(forceReload = false) {
            // Return cached promise if already loading
            if (_rmProductsLoadPromise && !forceReload) return _rmProductsLoadPromise;
            
            // Skip if already loaded and not forcing reload
            if (rmProductsLoadedFromDB && !forceReload) {
                return true;
            }
            
            if (!supabase) {
                console.log('Supabase not available, using cached raw materials');
                return false;
            }
            
            _rmProductsLoadPromise = (async () => {
                try {
                    console.log('Loading RM products from Supabase...');
                    const { data, error } = await supabase
                    .from('raw_materials')
                    .select('*');
                
                if (error) {
                    console.error('Error loading raw materials:', error);
                    return false;
                }
                
                if (data && data.length > 0) {
                    // Convert array to object keyed by stock_code
                    // Support multiple expiry dates per stock_code + batch_number
                    rawMaterialsDatabase = {};
                    data.forEach(product => {
                        const stockCode = product.stock_code || product.StockCode || product.stockcode;
                        const description = product.description || product.Description;
                        const batchNumber = product.batch_number || product.BatchNumber || product.batchnumber;
                        const expiryDate = product.expiry_date || product.ExpiryDate || product.expirydate || null;
                        
                        if (stockCode) {
                            if (!rawMaterialsDatabase[stockCode]) {
                                rawMaterialsDatabase[stockCode] = {
                                    description: description || '',
                                    batches: {}
                                };
                            }
                            if (batchNumber) {
                                if (!rawMaterialsDatabase[stockCode].batches[batchNumber]) {
                                    rawMaterialsDatabase[stockCode].batches[batchNumber] = {
                                        expiryDates: []
                                    };
                                }
                                // Add expiry date if not already in the array
                                if (expiryDate && !rawMaterialsDatabase[stockCode].batches[batchNumber].expiryDates.includes(expiryDate)) {
                                    rawMaterialsDatabase[stockCode].batches[batchNumber].expiryDates.push(expiryDate);
                                }
                            }
                        }
                    });
                    // Cache in localStorage for offline use
                    localStorage.setItem('rawMaterialsDatabase', JSON.stringify(rawMaterialsDatabase));
                    rmProductsLoadedFromDB = true;
                    console.log(`Loaded ${Object.keys(rawMaterialsDatabase).length} RM products from Supabase`);
                    return true;
                }
                return false;
            } catch (err) {
                console.error('Failed to load raw materials from Supabase:', err);
                return false;
            }
            })();
            
            return _rmProductsLoadPromise;
        }

        // Load product types from Supabase
        // Table structure: type (column A), stock_code (column B), description (column C)
        let _productTypesLoadPromise = null;
        async function loadProductTypesFromSupabase(forceReload = false) {
            // Return cached promise if already loading
            if (_productTypesLoadPromise && !forceReload) return _productTypesLoadPromise;
            
            // Skip if already loaded and not forcing reload
            if (productTypesLoadedFromDB && !forceReload) {
                return true;
            }
            
            if (!supabase) {
                console.log('Supabase not available, using cached product types');
                return false;
            }
            
            _productTypesLoadPromise = (async () => {
                try {
                    console.log('Loading product types from Supabase...');
                    const { data, error } = await supabase
                        .from('product_types')
                        .select('type,stock_code,description'); // Only select needed fields
                
                if (error) {
                    console.error('Error loading product types:', error);
                    return false;
                }
                
                if (data && data.length > 0) {
                    productTypeDatabase = {};
                    data.forEach(item => {
                        // Column mapping: type (A), stock_code (B), description (C)
                        const stockCode = (item.stock_code || '').toUpperCase();
                        const productType = item.type || 'Non-Ingredient';
                        const description = item.description || '';
                        if (stockCode) {
                            productTypeDatabase[stockCode] = {
                                productType: productType,
                                description: description,
                                unitType: productType.toLowerCase() === 'ingredient' ? 'kg' : 'units'
                            };
                        }
                    });
                    localStorage.setItem('productTypeDatabase', JSON.stringify(productTypeDatabase));
                    productTypesLoadedFromDB = true;
                    console.log(`Loaded ${Object.keys(productTypeDatabase).length} product types from Supabase`);
                    return true;
                }
                return false;
            } catch (err) {
                console.error('Failed to load product types from Supabase:', err);
                return false;
            }
            })();
            
            return _productTypesLoadPromise;
        }
        
        // Live duplicate check against Supabase - checks ALL devices in the session
        async function checkDuplicateInSupabase(sessionId, sessionType, batchNumber, stockCode, expiryDate = null, palletNumber = null) {
            if (!supabase || !sessionId) return null;
            
            try {
                // All scans are in stock_scans table - only select fields needed for duplicate display
                let query = supabase
                    .from('stock_scans')
                    .select('id,scanned_at,created_at,scanned_by,device_id')
                    .eq('session_id', sessionId)
                    .eq('batch_number', batchNumber);
                
                // For RM, check stock_code and optionally expiry_date
                if (sessionType === 'RM') {
                    query = query.eq('stock_code', stockCode);
                    if (expiryDate) {
                        query = query.eq('expiry_date', expiryDate);
                    }
                } else {
                    // For FP, check pallet_number
                    if (palletNumber) {
                        query = query.eq('pallet_number', palletNumber);
                    }
                }
                
                const { data, error } = await query.limit(1);
                
                if (error) {
                    console.error('Error checking duplicate:', error);
                    return null;
                }
                if (data && data.length > 0) {
                    await logClientEvent('duplicate-detected', 'warning', sessionId, {
                        batchNumber,
                        stockCode,
                        sessionType
                    });
                    return data[0];
                }
                return null;
            } catch (err) {
                console.error('Failed to check duplicate in Supabase:', err);
                return null;
            }
        }
        
        // Get unit type for a stock code (kg for RM/Ingredient, units for PM/Non-Ingredient)
        function getUnitTypeForStockCode(stockCode) {
            if (!stockCode) return 'units';
            const upperCode = stockCode.toUpperCase();
            
            // Check product type database first
            if (productTypeDatabase[upperCode]) {
                return productTypeDatabase[upperCode].unitType;
            }
            
            // Default logic based on prefix
            if (upperCode.startsWith('RM')) {
                return 'kg'; // Raw Materials are measured in kg
            } else if (upperCode.startsWith('PM')) {
                return 'units'; // PM products are counted in units
            }
            
            // Default to units for unknown
            return 'units';
        }
        
        function saveProductDatabase() {
            localStorage.setItem('productDatabase', JSON.stringify(productDatabase));
            // Also save to Supabase if available
            if (supabase && productsLoadedFromDB) {
                // For manual product additions, we could sync to Supabase here
                console.log('Product database saved locally');
            }
        }
        
        function saveRawMaterialsDatabase() {
            localStorage.setItem('rawMaterialsDatabase', JSON.stringify(rawMaterialsDatabase));
            if (supabase && rmProductsLoadedFromDB) {
                console.log('Raw materials database saved locally');
            }
        }
        
        // Add a new FP product to Supabase
        async function addProductToSupabase(batchNumber, stockCode, description) {
            if (!supabase) return false;
            try {
                const { error } = await supabase
                    .from('products')
                    .upsert({ 
                        batch_number: batchNumber, 
                        stock_code: stockCode, 
                        description: description 
                    }, { onConflict: 'batch_number' });
                return !error;
            } catch (err) {
                console.error('Failed to add product to Supabase:', err);
                return false;
            }
        }
        
        // Add a new RM product to Supabase
        // Allows multiple entries with same stock_code + batch_number but different expiry_date
        async function addRawMaterialToSupabase(stockCode, description, batchNumber, expiryDate) {
            if (!supabase) return false;
            try {
                // First check if this exact combination already exists
                const { data: existing } = await supabase
                    .from('raw_materials')
                    .select('id')
                    .eq('stock_code', stockCode)
                    .eq('batch_number', batchNumber || '')
                    .eq('expiry_date', expiryDate || null)
                    .maybeSingle();
                
                if (existing) {
                    console.log('Raw material entry already exists');
                    return true; // Already exists, no need to add
                }
                
                // Insert new entry (allows multiple expiry dates for same stock_code + batch)
                const { error } = await supabase
                    .from('raw_materials')
                    .insert({ 
                        stock_code: stockCode, 
                        description: description,
                        batch_number: batchNumber || null,
                        expiry_date: expiryDate || null
                    });
                return !error;
            } catch (err) {
                console.error('Failed to add raw material to Supabase:', err);
                return false;
            }
        }

        // Generate device ID
        const DEVICE_ID = localStorage.getItem('deviceId') || (() => {
            const id = 'device_' + Math.random().toString(36).substring(2, 15);
            localStorage.setItem('deviceId', id);
            return id;
        })();

        // Get/set user name
        const getUserName = () => localStorage.getItem('userName') || '';
        const setUserName = (name) => localStorage.setItem('userName', name);
        
        // Get/set active stock take
        const getActiveStockTake = () => {
            const data = localStorage.getItem('activeStockTake');
            return data ? JSON.parse(data) : null;
        };
        const setActiveStockTake = (stockTake) => {
            localStorage.setItem('activeStockTake', JSON.stringify(stockTake));
        };
        const clearActiveStockTake = () => {
            localStorage.removeItem('activeStockTake');
        };
        
        // Session settings
        const getSessionSettings = () => {
            const defaults = {
                locationScanningEnabled: false,
                currentLocation: '',
                site: '',
                aisle: '',
                rack: ''
            };
            const data = localStorage.getItem('sessionSettings');
            return data ? { ...defaults, ...JSON.parse(data) } : defaults;
        };
        const saveSessionSettings = (settings) => {
            localStorage.setItem('sessionSettings', JSON.stringify(settings));
        };

        // Session management - track sessions per day
        const getSessionsForDate = (date, sessionType = null) => {
            const data = localStorage.getItem(`sessions_${date}`);
            const sessions = data ? JSON.parse(data) : [];
            if (sessionType) {
                return sessions.filter(s => s.sessionType === sessionType);
            }
            return sessions;
        };
        const saveSessionsForDate = (date, sessions) => {
            localStorage.setItem(`sessions_${date}`, JSON.stringify(sessions));
        };
        const getNextSessionNumber = (date, sessionType = 'FP') => {
            const sessions = getSessionsForDate(date, sessionType);
            return sessions.length + 1;
        };
        const addSession = async (date, session) => {
            session.date = session.date || date;
            const allSessions = getSessionsForDate(date);
            const existingIndex = allSessions.findIndex(s => s.id === session.id);
            if (existingIndex >= 0) {
                allSessions[existingIndex] = session;
            } else {
            allSessions.push(session);
            }
            saveSessionsForDate(date, allSessions);
            await saveSessionToSupabase(session);
        };
        const updateSession = async (date, sessionId, updates) => {
            const sessions = getSessionsForDate(date);
            const idx = sessions.findIndex(s => s.id === sessionId);
            if (idx >= 0) {
                sessions[idx].date = sessions[idx].date || date;
                sessions[idx] = { ...sessions[idx], ...updates };
                saveSessionsForDate(date, sessions);
                await saveSessionToSupabase(sessions[idx]);
            }
        };
        
        // Get active (non-completed) sessions for joining
        const getActiveSessionsForDate = (date) => {
            const sessions = getSessionsForDate(date);
            return sessions.filter(s => s.status === 'active');
        };
        
        // Add a device to an existing session
        const joinSession = async (date, sessionId, deviceId, userName) => {
            const sessions = getSessionsForDate(date);
            const idx = sessions.findIndex(s => s.id === sessionId);
            if (idx >= 0) {
                sessions[idx].date = sessions[idx].date || date;
                if (!sessions[idx].devices) {
                    sessions[idx].devices = [];
                }
                // Check if device already in session
                const existingDevice = sessions[idx].devices.find(d => d.deviceId === deviceId);
                if (existingDevice) {
                    // Reactivate the device
                    existingDevice.status = 'active';
                    existingDevice.userName = userName;
                    existingDevice.rejoinedAt = new Date().toISOString();
                    existingDevice.lastSeen = new Date().toISOString();
                } else {
                    sessions[idx].devices.push({
                        deviceId: deviceId,
                        userName: userName,
                        status: 'active',
                        joinedAt: new Date().toISOString(),
                        lastSeen: new Date().toISOString()
                    });
                }
                saveSessionsForDate(date, sessions);
                await saveSessionToSupabase(sessions[idx]);
                return sessions[idx];
            }
            return null;
        };
        
        // Mark a device as completed in a session (session stays open until ended manually)
        const markDeviceCompleted = async (date, sessionId, deviceId) => {
            const sessions = getSessionsForDate(date);
            const idx = sessions.findIndex(s => s.id === sessionId);
            if (idx >= 0) {
                sessions[idx].date = sessions[idx].date || date;
                if (sessions[idx].devices) {
                    const device = sessions[idx].devices.find(d => d.deviceId === deviceId);
                    if (device) {
                        device.status = 'completed';
                        device.completedAt = new Date().toISOString();
                        device.lastSeen = new Date().toISOString();
                    }
                }
                saveSessionsForDate(date, sessions);
                await saveSessionToSupabase(sessions[idx]);
                return sessions[idx];
            }
            return null;
        };
        
        // Get session by ID
        const getSessionById = (date, sessionId) => {
            const sessions = getSessionsForDate(date);
            return sessions.find(s => s.id === sessionId);
        };

        // Supabase session helpers
        const supabaseSessionsEnabled = Boolean(supabase);

        const mapSupabaseSession = (row) => ({
            id: row.id,
            sessionNumber: row.session_number,
            sessionType: row.session_type,
            date: row.take_date,
            startedBy: row.started_by,
            startedAt: row.started_at,
            completedAt: row.completed_at,
            status: row.status || 'active',
            devices: (row.metadata && row.metadata.devices) || [],
            metadata: row.metadata || {}
        });

        const buildSupabaseSessionPayload = (session) => {
            const fallbackDate = session.startedAt ? new Date(session.startedAt).toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
            return {
                id: session.id,
                session_type: session.sessionType,
                session_number: session.sessionNumber,
                take_date: session.date || fallbackDate,
                status: session.status || 'active',
                started_by: session.startedBy,
                started_at: session.startedAt,
                completed_at: session.completedAt || null,
                metadata: {
                    ...(session.metadata || {}),
                    devices: session.devices || [],
                    lastUpdatedBy: session.lastUpdatedBy || (session.devices?.find(d => d.deviceId === DEVICE_ID)?.userName || null),
                    lastUpdatedAt: new Date().toISOString()
                }
            };
        };

        async function syncSessionsFromSupabase(date) {
            if (!supabaseSessionsEnabled || !date) return;
            try {
                const { data, error } = await supabase
                    .from('stock_takes')
                    .select('*')
                    .eq('take_date', date)
                    .order('session_number', { ascending: true });
                if (error) throw error;
                let mapped = (data || []).map(mapSupabaseSession);
                const sessionIds = mapped.map(s => s.id).filter(Boolean);
                if (sessionIds.length > 0) {
                    const devicesBySession = await fetchSessionDevicesMap(sessionIds);
                    mapped = mapped.map(session => ({
                        ...session,
                        devices: devicesBySession[session.id] || session.devices || []
                    }));
                }
                saveSessionsForDate(date, mapped);
                return mapped;
            } catch (err) {
                console.error('Failed to sync sessions from Supabase:', err);
                await logClientEvent('session-sync-failed', 'error', null, { date, message: err.message });
                return null;
            }
        }

        async function saveSessionToSupabase(session) {
            if (!supabaseSessionsEnabled || !session) return true;
            const payload = buildSupabaseSessionPayload(session);
            const isDuplicateError = (err) => err?.code === '23505' || /duplicate key value/i.test(err?.message || '');

            try {
                const { error } = await supabase
                    .from('stock_takes')
                    .upsert(payload, { onConflict: 'id' });
                if (!error) {
                    return true;
                }

                if (isDuplicateError(error)) {
                    const { error: updateError } = await supabase
                        .from('stock_takes')
                        .update(payload)
                        .eq('id', session.id);
                    if (!updateError) {
                        return true;
                    }
                    throw updateError;
                }

                throw error;
            } catch (err) {
                console.error('Failed to save session to Supabase:', err);
                await logClientEvent('session-save-failed', 'error', session?.id || null, {
                    message: err?.message || 'unknown error',
                    code: err?.code || null,
                    details: err?.details || null
                });
                return false;
            }
        }

        async function fetchSessionDevicesMap(sessionIds = []) {
            if (!supabaseSessionsEnabled || sessionIds.length === 0) return {};
            try {
                const { data, error } = await supabase
                    .from('session_devices')
                    .select('*')
                    .in('session_id', sessionIds);
                if (error) throw error;
                return (data || []).reduce((acc, device) => {
                    if (!acc[device.session_id]) {
                        acc[device.session_id] = [];
                    }
                    acc[device.session_id].push({
                        id: device.id,
                        sessionId: device.session_id,
                        deviceId: device.device_id,
                        userName: device.user_name,
                        role: device.role,
                        status: device.status,
                        lastSeen: device.last_seen,
                        joinedAt: device.joined_at,
                        leftAt: device.left_at
                    });
                    return acc;
                }, {});
            } catch (err) {
                console.error('Failed to load session devices:', err);
                await logClientEvent('session-devices-failed', 'error', null, { ids: sessionIds, message: err.message });
                return {};
            }
        }

        async function upsertSessionDevicePresence(sessionId, status = 'active', sessionSnapshot = null) {
            if (!supabaseSessionsEnabled || !sessionId) return;

            const invokeHeartbeat = async () => {
                const { error } = await supabase.rpc('upsert_session_device', {
                    p_session_id: sessionId,
                    p_device_id: DEVICE_ID,
                    p_user_name: getUserName() || 'Unknown',
                    p_role: 'operator',
                    p_status: status
                });
                if (error) throw error;
            };

            const isMissingSessionError = (err) => {
                if (!err) return false;
                if (err.code === '23503') return true; // foreign key violation
                return typeof err.message === 'string' && err.message.includes('session_devices_session_id_fkey');
            };

            try {
                await invokeHeartbeat();
            } catch (err) {
                if (isMissingSessionError(err) && sessionSnapshot) {
                    console.warn('Heartbeat failed because session is missing in Supabase. Attempting to re-save session before retrying.');
                    const saved = await saveSessionToSupabase(sessionSnapshot);
                    if (saved) {
                        await new Promise((resolve) => setTimeout(resolve, 300));
                        try {
                            await invokeHeartbeat();
                            return;
                        } catch (retryErr) {
                            console.error('Heartbeat retry still failing:', retryErr);
                            await logClientEvent('heartbeat-retry-failed', 'error', sessionId, {
                                status,
                                message: retryErr?.message || 'retry failed',
                                code: retryErr?.code || null
                            });
                            return;
                        }
                    }
                }

                console.error('Heartbeat failed:', err);
                await logClientEvent('heartbeat-failed', 'warning', sessionId, {
                    status,
                    message: err?.message || 'unknown error',
                    code: err?.code || null,
                    details: err?.details || null
                });
            }
        }

        async function changeSessionStatusSupabase(session, nextStatus, reason = '', metadata = {}) {
            if (!supabaseSessionsEnabled || !session?.id) return null;
            try {
                const { data: existing } = await supabase
                    .from('stock_takes')
                    .select('status')
                    .eq('id', session.id)
                    .maybeSingle();
                const timestamps = {
                    paused_at: nextStatus === 'paused' ? new Date().toISOString() : session.paused_at,
                    resumed_at: nextStatus === 'active' ? new Date().toISOString() : session.resumed_at,
                    completed_at: nextStatus === 'completed' ? new Date().toISOString() : session.completed_at
                };
                const { data, error } = await supabase
                    .from('stock_takes')
                    .update({ status: nextStatus, metadata: { ...(session.metadata || {}), ...metadata }, ...timestamps })
                    .eq('id', session.id)
                    .select()
                    .maybeSingle();
                if (error) throw error;
                await supabase
                    .from('session_status_events')
                    .insert({
                        session_id: session.id,
                        previous_status: existing?.status || session.status,
                        next_status: nextStatus,
                        reason,
                        actor: getUserName() || 'Unknown',
                        actor_device_id: DEVICE_ID,
                        metadata
                    });
                await updateSession(session.date, session.id, { status: nextStatus, ...timestamps, metadata: { ...(session.metadata || {}), ...metadata } });
                return data;
            } catch (err) {
                console.error('Failed to update session status:', err);
                await logClientEvent('session-status-failed', 'error', session?.id || null, { nextStatus, reason, message: err.message });
                return null;
            }
        }

        async function logClientEvent(eventType, severity = 'info', sessionId = null, payload = {}) {
            if (!supabase) return;
            try {
                await supabase.rpc('log_event', {
                    p_event_type: eventType,
                    p_severity: severity,
                    p_session_id: sessionId,
                    p_device_id: DEVICE_ID,
                    p_payload: payload
                });
            } catch (err) {
                const unauthorized = err?.code === 'PGRST301' || err?.code === '401' || /Unauthorized/i.test(err?.message || '');
                if (unauthorized) {
                    console.debug('log_event skipped (unauthorized)');
                } else {
                    console.warn('log_event failed', err);
                }
            }
        }

        class ScannerApp {
            constructor() {
                this.scans = [];
                this.scanner = null;
                this.preferredCameraId = null;
                this.isScanning = false;
                this.currentScan = null;
                this.showingCaseEntry = false;
                this.showingProductDB = false;
                this.showingRMProductDB = false;
                this.showingSettings = false;
                this.showingStartStockTake = false;
                this.showingExpirySelection = false;
                this.showingSessionHistory = false;
                this.selectedStockTakeType = null; // 'FP' or 'RM' - selected before session
                this.historySessions = [];
                this.historyScans = [];
                this.historyLoading = false; // Loading state for session history
                this.selectedHistorySession = null;
                this.pendingScan = null;
                this.pendingScanKeys = new Set(); // Track scans being processed to prevent double-capture
                this.currentTakeDate = new Date().toISOString().split('T')[0];
                this.syncInterval = null;
                this.heartbeatInterval = null;
                this.lastHeartbeatAt = 0;
                this.isGitHubPages = isGitHubPages;
                this.hasPrefetchedReferenceData = false;
                this.activeStockTake = getActiveStockTake();
                this.sessionSettings = getSessionSettings();
                this.lastSessionSync = 0;
                this.isBrowserOnline = navigator.onLine;
                
                // Modal State
                this.modalState = null; // { title, message, type, fields, onConfirm, onCancel, confirmText, cancelText }
                
                // Performance optimization
                this._renderScheduled = false;
                this._lastRenderTime = 0;
                this._renderDebounceMs = 16; // ~60fps max
                
                this.init();
            }

            get useNeonDB() {
                return db.mode === 'netlify';
            }

            get usingSupabaseDB() {
                return db.mode === 'supabase';
            }
            
            toggleLocationScanning() {
                this.sessionSettings.locationScanningEnabled = !this.sessionSettings.locationScanningEnabled;
                if (!this.sessionSettings.locationScanningEnabled) {
                    this.sessionSettings.currentLocation = '';
                    this.sessionSettings.site = '';
                    this.sessionSettings.aisle = '';
                    this.sessionSettings.rack = '';
                }
                saveSessionSettings(this.sessionSettings);
                this.render();
            }
            
            setLocation(location) {
                this.sessionSettings.currentLocation = location;
                saveSessionSettings(this.sessionSettings);
                this.render();
            }

            updateLocationHierarchy(level, value) {
                if (!['site', 'aisle', 'rack'].includes(level)) return;
                this.sessionSettings[level] = value;
                saveSessionSettings(this.sessionSettings);
                // Don't re-render here - it causes the input to lose focus
                // The value is already saved, and the UI will update on next render
            }
            
            promptForLocation() {
                this.showModal({
                    title: 'Set Location',
                    message: 'Enter current location (e.g., Rack A1, Floor 1):',
                    type: 'input',
                    confirmText: 'Set Location',
                    onConfirm: (data) => {
                        this.setLocation(data.value.trim());
                    }
                });
                // Pre-fill value
                setTimeout(() => {
                    const input = document.getElementById('modal-input');
                    if (input) input.value = this.sessionSettings.currentLocation || '';
                }, 50);
            }

            triggerHaptic(type = 'light') {
                if (!navigator.vibrate) return;
                const patterns = {
                    success: [40, 20, 40],
                    warning: [100, 50, 100],
                    heavy: [200],
                    light: [20]
                };
                navigator.vibrate(patterns[type] || patterns.light);
            }

            async prefetchReferenceData() {
                if (!supabase) return;
                await Promise.all([
                    loadProductsFromSupabase(),
                    loadRawMaterialsFromSupabase(),
                    loadProductTypesFromSupabase()
                ]);
                this.hasPrefetchedReferenceData = true;
            }

            async refreshSessionsFromSupabase(force = false) {
                if (!supabaseSessionsEnabled || !this.isBrowserOnline) return;
                const now = Date.now();
                // Throttle to once per 10 seconds unless forced
                if (!force && this.lastSessionSync && (now - this.lastSessionSync) < 10000) {
                    return;
                }
                await syncSessionsFromSupabase(this.currentTakeDate);
                this.lastSessionSync = Date.now();
            }

            async init() {
                // Show loading state immediately
                const app = document.getElementById('app');
                app.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-white">
                        <div class="text-center">
                            <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"></div>
                            <p class="text-slate-600 font-medium">Loading...</p>
                        </div>
                    </div>
                `;
                
                // Initialize database and load data in parallel for speed
                const initPromises = [
                    db.init(),
                    this.refreshSessionsFromSupabase(true)
                ];
                
                // Load products in parallel if Supabase is available
                if (supabase) {
                    initPromises.push(
                        loadProductsFromSupabase(),
                        loadRawMaterialsFromSupabase(),
                        loadProductTypesFromSupabase()
                    );
                }
                
                await Promise.all(initPromises);
                
                // Check if there's an active stock take for today
                if (this.activeStockTake && this.activeStockTake.date === this.currentTakeDate) {
                    // Continue with existing stock take
                    if (this.useNeonDB) {
                        await this.ensureStockTake();
                    }
                    this.startAutoSync();
                    await this.loadScans();
                    if (supabaseSessionsEnabled) {
                        this.startHeartbeat('active');
                    }
                } else {
                    // Show start stock take screen
                    this.showingStartStockTake = true;
                }
                
                this.render();
            }

            isOfflineMode() {
                if (!this.isBrowserOnline) {
                    return true;
                }
                return !this.useNeonDB && !(supabaseSessionsEnabled && this.activeStockTake?.id);
            }

            async handleConnectivityChange(isOnline) {
                this.isBrowserOnline = isOnline;
                if (!isOnline) {
                    if (supabaseSessionsEnabled && this.activeStockTake?.id) {
                        this.stopHeartbeat('offline');
                    }
                    this.render();
                    return;
                }

                if (supabaseSessionsEnabled && this.activeStockTake?.id) {
                    const hbStatus = this.activeStockTake.status === 'paused' ? 'paused' : 'active';
                    this.startHeartbeat(hbStatus);
                }

                await this.refreshSessionsFromSupabase(true);
                await this.loadScans();
                this.render();
            }

            selectStockTakeType(type, userName) {
                if (!userName || userName.trim() === '') {
                    alert('Please enter your name');
                    return;
                }
                setUserName(userName.trim());
                this.selectedStockTakeType = type;
                this.render();
            }

            async startNewStockTake(userName, sessionType = 'FP') {
                if (!userName || userName.trim() === '') {
                    alert('Please enter your name');
                    return;
                }
                
                setUserName(userName.trim());
                await this.refreshSessionsFromSupabase(true);
                if (!this.hasPrefetchedReferenceData) {
                    await this.prefetchReferenceData();
                }
                
                // Get next session number for today (per type)
                const sessionNumber = getNextSessionNumber(this.currentTakeDate, sessionType);
                const sessionId = `${this.currentTakeDate}-${sessionType}-${sessionNumber}`;
                
                const deviceInfo = { 
                    deviceId: DEVICE_ID, 
                    userName: userName.trim(), 
                    status: 'active',
                    joinedAt: new Date().toISOString(),
                    lastSeen: new Date().toISOString()
                };
                
                this.activeStockTake = {
                    id: sessionId,
                    sessionNumber: sessionNumber,
                    sessionType: sessionType, // 'FP' or 'RM'
                    date: this.currentTakeDate,
                    startedBy: userName.trim(),
                    startedAt: new Date().toISOString(),
                    devices: [deviceInfo],
                    status: 'active'
                };
                
                // Save session to sessions list (with devices)
                await addSession(this.currentTakeDate, {
                    id: sessionId,
                    sessionNumber: sessionNumber,
                    sessionType: sessionType,
                    date: this.currentTakeDate,
                    startedBy: userName.trim(),
                    startedAt: new Date().toISOString(),
                    devices: [deviceInfo],
                    status: 'active'
                });
                
                setActiveStockTake(this.activeStockTake);
                this.scans = [];
                if (!this.useNeonDB) {
                    clearLocalScanStorage();
                }
                
                this.showingStartStockTake = false;
                this.selectedStockTakeType = null;
                
                if (this.useNeonDB) {
                    await this.ensureStockTake();
                }
                this.startAutoSync();
                if (supabaseSessionsEnabled) {
                    this.startHeartbeat('active');
                }
                
                this.loadScans();
                this.triggerHaptic('success');
                this.render();
            }
            
            async joinExistingSession(sessionId, userName) {
                if (!userName || userName.trim() === '') {
                    alert('Please enter your name');
                    return;
                }
                
                setUserName(userName.trim());
                await this.refreshSessionsFromSupabase();
                if (!this.hasPrefetchedReferenceData) {
                    await this.prefetchReferenceData();
                }
                
                // Join the session
                const updatedSession = await joinSession(this.currentTakeDate, sessionId, DEVICE_ID, userName.trim());
                
                if (!updatedSession) {
                    alert('Session not found');
                    return;
                }
                
                this.activeStockTake = {
                    id: updatedSession.id,
                    sessionNumber: updatedSession.sessionNumber,
                    sessionType: updatedSession.sessionType,
                    date: this.currentTakeDate,
                    startedBy: updatedSession.startedBy,
                    startedAt: updatedSession.startedAt,
                    devices: updatedSession.devices,
                    status: updatedSession.status
                };
                
                setActiveStockTake(this.activeStockTake);
                
                // Don't clear scans - we're joining an existing session
                this.showingStartStockTake = false;
                this.selectedStockTakeType = null;
                
                if (this.useNeonDB) {
                    await this.ensureStockTake();
                }
                this.startAutoSync();
                if (supabaseSessionsEnabled) {
                    this.startHeartbeat('active');
                }
                
                this.loadScans();
                this.triggerHaptic('success');
                this.render();
            }

            async endStockTake() {
                const sessionId = this.activeStockTake?.id;
                const sessionDate = this.activeStockTake?.date || this.currentTakeDate;

                if (!sessionId) {
                    alert('No active stock take to complete.');
                    return;
                }

                const finalizeDeviceWrapUp = async () => {
                    const updatedSession = await markDeviceCompleted(sessionDate, sessionId, DEVICE_ID);
                    if (supabaseSessionsEnabled) {
                        this.stopHeartbeat('inactive');
                    }
                    if (updatedSession) {
                        const remaining = updatedSession.devices?.filter(d => d.status === 'active').length || 0;
                        if (remaining > 0) {
                            alert(`You are marked as completed.\n\n${remaining} device(s) are still counting. When everyone finishes, end the stock take from Session History.`);
                        } else {
                            alert('All devices are now marked complete. End the entire stock take from Session History when you are ready to finalize.');
                        }
                    } else {
                        alert('You are marked as completed. End the stock take from Session History when ready.');
                    }
                    this.stopAutoSync();
                    clearActiveStockTake();
                    this.activeStockTake = null;
                    this.scans = [];
                    this.selectedStockTakeType = null;
                    this.showingStartStockTake = true;
                    this.render();
                };

                if (this.scans.length === 0) {
                    const confirmDone = confirm('No items were scanned on this device. Mark yourself as completed? This will NOT end the overall stock take.');
                    if (!confirmDone) return;
                    await finalizeDeviceWrapUp();
                    return;
                }

                await this.loadScans();

                const currentSession = getSessionById(sessionDate, sessionId);
                const deviceScanCount = this.scans.filter(s => s.deviceId === DEVICE_ID).length;
                const otherActiveDevices = currentSession?.devices?.filter(d => d.status === 'active' && d.deviceId !== DEVICE_ID) || [];
                const completedDevices = currentSession?.devices?.filter(d => d.status === 'completed') || [];

                let summary = `Mark Your Count Complete\n\n` +
                    `Your scans: ${deviceScanCount}\n` +
                    `Total session scans: ${this.scans.length}\n\n`;

                if (otherActiveDevices.length > 0) {
                    summary += ` ${otherActiveDevices.length} other device(s) are still active:\n`;
                    otherActiveDevices.forEach(d => {
                        summary += `   ${d.userName}\n`;
                    });
                    summary += `\nThis only marks your device as completed.\nThe stock take stays open until it is ended from Session History.\n\n`;
                } else if (completedDevices.length > 0) {
                    summary += ` ${completedDevices.length} device(s) already marked done.\n`;
                    summary += `Use Session History to end the stock take for everyone.\n\n`;
                } else {
                    summary += `This will mark only your device as completed.\nEnd the full stock take from Session History when ready.\n\n`;
                }

                summary += `Proceed with marking yourself done?`;
                const proceed = confirm(summary);
                if (!proceed) return;

                const exportData = confirm('Export your scans before marking done? Click OK to export, or Cancel to skip.');
                if (exportData) {
                    this.exportStockCount();
                }

                await finalizeDeviceWrapUp();
            }

            async endSessionFromList(sessionId) {
                // End a session from the session selection list
                this.showModal({
                    title: 'End Session',
                    message: 'Are you sure you want to end this session? All active devices will be marked as completed.',
                    type: 'confirm',
                    confirmText: 'End Session',
                    cancelText: 'Cancel',
                    onConfirm: async () => {
                        try {
                            if (supabaseSessionsEnabled && supabase) {
                                // Update session status in Supabase
                                const { error } = await supabase
                                    .from('stock_sessions')
                                    .update({ 
                                        status: 'completed',
                                        ended_at: new Date().toISOString()
                                    })
                                    .eq('id', sessionId);
                                
                                if (error) {
                                    console.error('Error ending session:', error);
                                    alert('Failed to end session. Please try again.');
                                    return;
                                }
                            }
                            
                            // Update local storage
                            const sessionDate = this.currentTakeDate;
                            await updateSession(sessionDate, sessionId, { status: 'completed' });
                            
                            // Refresh the session list
                            await this.refreshSessionsFromSupabase();
                            this.render();
                            
                            alert('Session ended successfully.');
                        } catch (err) {
                            console.error('Error ending session:', err);
                            alert('Failed to end session. Please try again.');
                        }
                    }
                });
            }

            async ensureStockTake() {
                if (!this.useNeonDB) return;
                await db.insertStockTake(this.currentTakeDate);
            }

            async loadScans() {
                const sessionType = this.activeStockTake?.sessionType || 'FP';
                const sessionId = this.activeStockTake?.id;
                
                if (this.useNeonDB) {
                    const data = await db.getStockScans(this.currentTakeDate);
                    
                    this.scans = data
                        .filter(row => !row.session_type || row.session_type === sessionType) // Filter by session type
                        .map(row => ({
                            id: row.id,
                            timestamp: new Date(row.scanned_at).getTime(),
                            date: new Date(row.scanned_at).toLocaleDateString(),
                            time: new Date(row.scanned_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                            raw: row.raw_code,
                            batchNumber: row.batch_number,
                            palletNumber: row.pallet_number,
                            casesOnPallet: row.cases_on_pallet,
                            actualCases: row.actual_cases,
                            stockCode: row.stock_code,
                            description: row.description,
                            valid: true,
                            deviceId: row.device_id,
                            scannedBy: row.scanned_by || 'Unknown',
                            sessionType: row.session_type || 'FP',
                            expiryDate: row.expiry_date,
                            location: row.location,
                            site: row.site,
                            aisle: row.aisle,
                            rack: row.rack,
                            unitType: row.unit_type || (sessionType === 'RM' ? getUnitTypeForStockCode(row.stock_code) : 'cases')
                        }));
                } else if (supabase && sessionId) {
                    // Load ALL scans from stock_scans table, filtered by session
                    try {
                        // Only select fields we actually need for display
                        const { data, error } = await supabase
                            .from('stock_scans')
                            .select('id,scanned_at,raw_code,batch_number,pallet_number,cases_on_pallet,actual_cases,stock_code,description,device_id,scanned_by,session_type,expiry_date,location,site,aisle,rack,unit_type')
                            .eq('session_id', sessionId)
                            .order('scanned_at', { ascending: false });
                        
                        if (error) {
                            console.error('Error loading scans from Supabase:', error);
                            await logClientEvent('scan-load-failed', 'error', sessionId, { message: error.message });
                            this.scans = [];
                            return;
                        }
                        
                        this.scans = (data || []).map(row => ({
                            id: row.id,
                            timestamp: new Date(row.scanned_at).getTime(),
                            date: new Date(row.scanned_at).toLocaleDateString(),
                            time: new Date(row.scanned_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                            raw: row.raw_code,
                            batchNumber: row.batch_number,
                            palletNumber: row.pallet_number || '',
                            casesOnPallet: row.cases_on_pallet || 0,
                            actualCases: row.actual_cases,
                            stockCode: row.stock_code,
                            description: row.description,
                            valid: true,
                            deviceId: row.device_id,
                            scannedBy: row.scanned_by || 'Unknown',
                            sessionType: row.session_type || sessionType,
                            expiryDate: row.expiry_date,
                            location: row.location,
                            site: row.site,
                            aisle: row.aisle,
                            rack: row.rack,
                            unitType: row.unit_type || (sessionType === 'RM' ? getUnitTypeForStockCode(row.stock_code) : 'cases')
                        }));
                        
                        console.log(`Loaded ${this.scans.length} scans from stock_scans for session ${sessionId}`);
                    } catch (err) {
                        console.error('Failed to load scans from Supabase:', err);
                        await logClientEvent('scan-load-failed', 'error', sessionId, { message: err.message });
                        this.scans = [];
                    }
                } else {
                    // Fallback to localStorage
                    const allScans = localStorage_db.list('scan:');
                    // Filter by session type
                    this.scans = allScans.filter(s => !s.sessionType || s.sessionType === sessionType);
                    this.scans.sort((a, b) => b.timestamp - a.timestamp);
                }
            }

            startAutoSync() {
                this.stopAutoSync();
                const canSync = this.useNeonDB || (supabaseSessionsEnabled && this.activeStockTake?.id);
                if (!canSync) {
                    return;
                }
                const runSync = async () => {
                    if (!this.isBrowserOnline) return;
                    // Don't reload/re-render during case entry or modal input to avoid losing input
                    if (this.showingCaseEntry) return;
                    if (this.modalState) return; // Skip sync while modal is open
                    
                    try {
                        if (this.useNeonDB) {
                            await this.loadScans();
                        } else if (supabaseSessionsEnabled && this.activeStockTake?.id) {
                            await this.refreshSessionsFromSupabase();
                            await this.loadScans();
                        }
                        this.render();
                    } catch (err) {
                        console.warn('Auto-sync failed', err);
                    }
                };
                runSync();
                // Sync every 10 seconds instead of 5 to reduce load
                this.syncInterval = setInterval(runSync, 10000);
            }

            stopAutoSync() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                    this.syncInterval = null;
                }
            }

            startHeartbeat(status = 'active') {
                if (!supabaseSessionsEnabled || !this.activeStockTake?.id || !this.isBrowserOnline) return;
                this.stopHeartbeat();
                const send = async () => {
                    if (!this.isBrowserOnline) return;
                    await upsertSessionDevicePresence(this.activeStockTake.id, status, this.activeStockTake);
                    this.lastHeartbeatAt = Date.now();
                };
                send();
                this.heartbeatInterval = setInterval(send, HEARTBEAT_INTERVAL_MS);
            }

            stopHeartbeat(status = 'inactive') {
                if (this.heartbeatInterval) {
                    clearInterval(this.heartbeatInterval);
                    this.heartbeatInterval = null;
                }
                if (supabaseSessionsEnabled && this.activeStockTake?.id && status && this.isBrowserOnline) {
                    upsertSessionDevicePresence(this.activeStockTake.id, status, this.activeStockTake);
                }
            }

            async getPreferredCameraId() {
                if (this.preferredCameraId) return this.preferredCameraId;
                try {
                    const cameras = await Html5Qrcode.getCameras();
                    if (!cameras || cameras.length === 0) {
                        return null;
                    }
                    const backCamera = cameras.find(cam => /back|rear|environment/i.test(cam.label));
                    this.preferredCameraId = (backCamera || cameras[0]).id;
                    return this.preferredCameraId;
                } catch (err) {
                    console.warn('Camera enumeration failed', err);
                    return null;
                }
            }

            parseQRCode(code) {
                const sessionType = this.activeStockTake?.sessionType || 'FP';
                
                // FP (Finished Products) - 13 digit numeric code
                // Format: BBBBBPPPPCCCC (5 batch + 4 pallet + 4 cases)
                if (sessionType === 'FP') {
                    if (!/^\d{13}$/.test(code)) {
                        return {
                            valid: false,
                            raw: code,
                            error: 'Not a valid 13-digit FP code'
                        };
                    }

                    const batchNumber = code.substring(0, 5);    // First 5 digits = batch
                    const palletNumber = code.substring(5, 9);   // Next 4 digits = pallet
                    const cases = code.substring(9, 13);         // Last 4 digits = cases

                    const productInfo = productDatabase[batchNumber] || {
                        stockCode: 'UNKNOWN',
                        description: 'Unknown Product - Add to database'
                    };

                    return {
                        valid: true,
                        raw: code,
                        batchNumber: batchNumber,
                        palletNumber: palletNumber,
                        casesOnPallet: parseInt(cases),
                        stockCode: productInfo.stockCode,
                        description: productInfo.description
                    };
                }
                
                // RM (Raw Materials) - starts with a letter
                // First QR = stock code only (e.g., "ABC123")
                // Second QR = string with stock code + batch (e.g., "ABC123-BATCH456" or "ABC123BATCH456")
                if (sessionType === 'RM') {
                    // Check if it starts with a letter (RM code)
                    if (!/^[A-Za-z]/.test(code)) {
                        return {
                            valid: false,
                            raw: code,
                            error: 'RM code must start with a letter'
                        };
                    }
                    
                    // Store first scan as pending if we only got stock code
                    // Check if this is a stock code or full batch string
                    const stockCodeMatch = code.match(/^([A-Za-z][A-Za-z0-9\-]*)/);
                    if (!stockCodeMatch) {
                        return {
                            valid: false,
                            raw: code,
                            error: 'Invalid RM code format'
                        };
                    }
                    
                    // Try to find the stock code in database
                    let foundStockCode = null;
                    let batchNumber = null;
                    let batchFromDatabase = false;
                    
                    // First, try to match known stock codes
                    const knownStockCodes = Object.keys(rawMaterialsDatabase).sort((a, b) => b.length - a.length);
                    
                    for (const sc of knownStockCodes) {
                        if (code.toUpperCase().startsWith(sc.toUpperCase())) {
                            foundStockCode = sc;
                            // Extract batch number from remaining string
                            const remaining = code.substring(sc.length);
                            const extractedBatch = remaining.replace(/^[\-_\s]+/, '').trim() || null;
                            
                            // Check if this batch exists in the database for this stock code
                            const rmInfo = rawMaterialsDatabase[sc];
                            if (rmInfo && rmInfo.batches && extractedBatch) {
                                // Try to find a matching batch in the database
                                const knownBatches = Object.keys(rmInfo.batches);
                                // Look for exact match first
                                const exactMatch = knownBatches.find(b => extractedBatch.toUpperCase().includes(b.toUpperCase()) || b.toUpperCase().includes(extractedBatch.toUpperCase()));
                                if (exactMatch) {
                                    batchNumber = exactMatch;
                                    batchFromDatabase = true;
                                } else {
                                    // No match found in database - use extracted batch
                                    batchNumber = extractedBatch;
                                }
                            } else {
                                batchNumber = extractedBatch;
                            }
                            break;
                        }
                    }
                    
                    // If not found in database, try to parse the code
                    if (!foundStockCode) {
                        // Assume format is either:
                        // 1. Just stock code: "ABC123"
                        // 2. Stock code + separator + batch: "ABC123-BATCH456" or "ABC123_BATCH456"
                        const parts = code.split(/[\-_]/);
                        if (parts.length >= 1) {
                            foundStockCode = parts[0];
                            batchNumber = parts.slice(1).join('-') || null;
                        }
                    }
                    
                    if (!foundStockCode) {
                        return {
                            valid: false,
                            raw: code,
                            error: 'Could not parse stock code from: ' + code
                        };
                    }
                    
                    // Look up product info
                    const rmInfo = rawMaterialsDatabase[foundStockCode] || rawMaterialsDatabase[foundStockCode.toUpperCase()];
                    const description = rmInfo?.description || 'Unknown Raw Material - Add to database';
                    
                    // Determine unit type based on stock code prefix
                    const unitType = getUnitTypeForStockCode(foundStockCode);
                    
                    // Check for expiry dates if batch number is known
                    let expiryDate = null;
                    let availableExpiryDates = [];
                    let needsExpiryConfirmation = false;
                    
                    if (rmInfo && batchNumber && rmInfo.batches && rmInfo.batches[batchNumber]) {
                        const batchInfo = rmInfo.batches[batchNumber];
                        // Support both old format (expiryDate) and new format (expiryDates array)
                        if (batchInfo.expiryDates && Array.isArray(batchInfo.expiryDates)) {
                            availableExpiryDates = batchInfo.expiryDates.filter(d => d != null);
                            if (availableExpiryDates.length === 1) {
                                expiryDate = availableExpiryDates[0];
                            } else if (availableExpiryDates.length > 1) {
                                // Multiple expiry dates - need confirmation
                                needsExpiryConfirmation = true;
                            }
                        } else if (batchInfo.expiryDate) {
                            // Old format - single expiry date
                            expiryDate = batchInfo.expiryDate;
                            availableExpiryDates = [expiryDate];
                        }
                    }
                    
                    return {
                        valid: true,
                        raw: code,
                        stockCode: foundStockCode,
                        batchNumber: batchNumber || 'N/A',
                        palletNumber: null, // RM doesn't use pallets
                        casesOnPallet: 0, // Will be entered as quantity
                        description: description,
                        expiryDate: expiryDate,
                        availableExpiryDates: availableExpiryDates,
                        needsExpiryConfirmation: needsExpiryConfirmation,
                        isRawMaterial: true,
                        unitType: unitType // 'kg' or 'units'
                    };
                }
                
                return {
                    valid: false,
                    raw: code,
                    error: 'Unknown session type'
                };
            }

            async checkDuplicate(batchNumber, palletNumber, stockCode = null, expiryDate = null) {
                if (this.useNeonDB) {
                    return await db.checkDuplicate(this.currentTakeDate, batchNumber, palletNumber);
                } else if (supabase && this.activeStockTake?.id) {
                    // Live check against Supabase stock_scans for all devices in this session
                    const sessionType = this.activeStockTake?.sessionType || 'FP';
                    return await checkDuplicateInSupabase(
                        this.activeStockTake.id,
                        sessionType,
                        batchNumber,
                        stockCode,
                        expiryDate,
                        palletNumber
                    );
                } else {
                    // Fallback to local check
                    if (this.activeStockTake?.sessionType === 'RM') {
                        return this.scans.find(s => 
                            s.batchNumber === batchNumber && 
                            s.stockCode === stockCode &&
                            (!expiryDate || s.expiryDate === expiryDate)
                        );
                    } else {
                        return this.scans.find(s => 
                            s.batchNumber === batchNumber && 
                            s.palletNumber === palletNumber
                        );
                    }
                }
            }

            async startScanning() {
                this.isScanning = true;
                this.render();
                
                setTimeout(async () => {
                    try {
                        this.scanner = new Html5Qrcode("scanner", {
                            verbose: false,
                            experimentalFeatures: {
                                useBarCodeDetectorIfSupported: true
                            }
                        });
                        
                        const config = {
                            fps: 10,
                            qrbox: function(viewfinderWidth, viewfinderHeight) {
                                const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                                const size = Math.floor(minEdge * 0.7);
                                return { width: size, height: size };
                            },
                            aspectRatio: 1.0,
                            showTorchButtonIfSupported: true,
                            showZoomSliderIfSupported: true,
                            defaultZoomValueIfSupported: 2
                        };
                        
                        await this.scanner.start(
                            { facingMode: "environment" },
                            config,
                            (decodedText, decodedResult) => {
                                console.log('SCAN SUCCESS:', decodedText, decodedResult);
                                this.onScanSuccess(decodedText);
                            },
                            (errorMessage) => {
                                // Silent - no QR in frame
                            }
                        );
                        
                        // Fix for mobile browsers: force video element attributes
                        setTimeout(() => {
                            const videoElement = document.querySelector('#scanner video');
                            if (videoElement) {
                                videoElement.setAttribute('playsinline', '');
                                videoElement.setAttribute('webkit-playsinline', '');
                                videoElement.setAttribute('autoplay', '');
                                videoElement.muted = true;
                                videoElement.playsInline = true;
                            }
                        }, 500);
                        
                    } catch (err) {
                        console.error('Camera error:', err);
                        let errorMsg = 'Camera error: ';
                        if (err.name === 'NotAllowedError') {
                            errorMsg += 'Camera permission denied. Please allow camera access in your browser settings.';
                        } else if (err.name === 'NotFoundError') {
                            errorMsg += 'No camera found on this device.';
                        } else if (err.name === 'NotReadableError') {
                            errorMsg += 'Camera is in use by another app.';
                        } else {
                            errorMsg += err.message || err;
                        }
                        alert(errorMsg);
                        this.isScanning = false;
                        this.render();
                    }
                }, 300);
            }

            async stopScanning() {
                if (this.scanner) {
                    try {
                        await this.scanner.stop();
                    } catch (err) {
                        console.log('Stop error:', err);
                    }
                    try {
                        this.scanner.clear();
                    } catch (err) {
                        console.log('Clear error:', err);
                    }
                    this.scanner = null;
                }
                this.isScanning = false;
                this.render();
            }

            // Generate a unique key for a scan to prevent double-capture
            getScanKey(parsed) {
                const sessionType = this.activeStockTake?.sessionType || 'FP';
                if (sessionType === 'RM') {
                    return `${parsed.stockCode}|${parsed.batchNumber}|${parsed.expiryDate || ''}`;
                } else {
                    return `${parsed.batchNumber}|${parsed.palletNumber}`;
                }
            }

            async onScanSuccess(code) {
                const cleanedCode = (code || '').trim();
                if (!cleanedCode) {
                    return;
                }
                if (navigator.vibrate) navigator.vibrate(200);
                
                this.stopScanning();
                
                const parsed = this.parseQRCode(cleanedCode);
                
                if (!parsed.valid) {
                    alert(parsed.error);
                    return;
                }
                
                // Check if this scan is already being processed (prevents rapid double-scan)
                const scanKey = this.getScanKey(parsed);
                if (this.pendingScanKeys.has(scanKey)) {
                    console.log('Scan already in progress:', scanKey);
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                    alert('This item is already being processed. Please wait.');
                    return;
                }
                
                // Check if expiry date confirmation is needed (multiple dates available)
                if (parsed.needsExpiryConfirmation && parsed.availableExpiryDates && parsed.availableExpiryDates.length > 1) {
                    // Show expiry date selection dialog
                    this.pendingScan = parsed;
                    this.showingExpirySelection = true;
                    this.render();
                    return;
                }

                // Check for duplicate - include stock_code and expiry for RM
                const duplicate = await this.checkDuplicate(
                    parsed.batchNumber, 
                    parsed.palletNumber,
                    parsed.stockCode,
                    parsed.expiryDate
                );
                
                if (duplicate) {
                    const timestamp = duplicate.scanned_at || duplicate.created_at || duplicate.date + ' ' + duplicate.time;
                    const scannedByName = duplicate.scanned_by || duplicate.scannedBy || 'Unknown';
                    const deviceInfo = duplicate.device_id || duplicate.deviceId || '';
                    const existingCases = duplicate.actual_cases || duplicate.actualCases || 0;
                    
                    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                    
                    const sessionType = this.activeStockTake?.sessionType || 'FP';
                    
                    // For FP, pallet cannot be scanned twice - must update
                    if (sessionType === 'FP') {
                        // Store duplicate info for update flow
                        parsed.isDuplicatePallet = true;
                        parsed.existingScanId = duplicate.id;
                        parsed.existingCases = existingCases;
                        
                        // Show modal to notify and confirm update
                        this.showModal({
                            title: ' Pallet Already Scanned',
                            message: `This pallet has already been scanned!\n\n` +
                                `Stock Code: ${parsed.stockCode}\n` +
                                `Batch: ${parsed.batchNumber}\n` +
                                `Pallet: ${parsed.palletNumber}\n` +
                                `Current Cases: ${existingCases}\n\n` +
                                `Scanned by: ${scannedByName}\n` +
                                `at ${new Date(timestamp).toLocaleString()}\n\n` +
                                `Would you like to update this pallet's count?`,
                            type: 'confirm',
                            confirmText: 'Update Count',
                            cancelText: 'Cancel',
                            onConfirm: () => {
                                // Proceed to case entry to update
                                this.pendingScanKeys.add(scanKey);
                                this.currentScan = parsed;
                                this.showingCaseEntry = true;
                                this.render();
                            }
                        });
                        return;
                    }
                    
                    // For RM, keep existing behavior
                    const rescan = confirm(
                        ` DUPLICATE SCAN DETECTED!\n\n` +
                        `Stock Code: ${parsed.stockCode}\n` +
                        `Batch: ${parsed.batchNumber}\n` +
                        (parsed.expiryDate ? `Expiry: ${parsed.expiryDate}\n` : '') +
                        `\nPreviously scanned by: ${scannedByName}\n` +
                        (deviceInfo ? `Device: ${deviceInfo}\n` : '') +
                        `at ${new Date(timestamp).toLocaleString()}\n\n` +
                        `Do you want to rescan this item?`
                    );
                    
                    if (!rescan) {
                        return;
                    }
                }
                
                // Mark this scan as pending to prevent double-capture
                this.pendingScanKeys.add(scanKey);
                
                this.currentScan = parsed;
                this.showingCaseEntry = true;
                this.render();
            }

            async saveScan(parsedData, actualCases) {
                const userName = getUserName();
                const sessionType = this.activeStockTake?.sessionType || 'FP';
                const sessionId = this.activeStockTake?.id || null;
                const locationPayload = this.sessionSettings.locationScanningEnabled ? {
                    location: this.sessionSettings.currentLocation || null,
                    site: this.sessionSettings.site || null,
                    aisle: this.sessionSettings.aisle || null,
                    rack: this.sessionSettings.rack || null
                } : {
                    location: null,
                    site: null,
                    aisle: null,
                    rack: null
                };
                
                // Check if this is an update to an existing pallet scan
                const isUpdate = parsedData.isDuplicatePallet && parsedData.existingScanId;
                
                console.log('Saving scan:', { parsedData, actualCases, userName, useNeonDB: this.useNeonDB, isGitHubPages: this.isGitHubPages, sessionType, sessionId, supabaseEnabled: !!supabase, isUpdate });
                
                // Check if we have a valid session for Supabase saves
                if (!this.useNeonDB && supabase && !sessionId) {
                    console.warn('No active session ID - scan will be saved to localStorage only');
                    alert('No active session. Please start or join a session first. Scan saved locally.');
                }
                
                if (this.useNeonDB) {
                    const result = await db.insertStockScan({
                        take_date: this.currentTakeDate,
                        batch_number: parsedData.batchNumber,
                        pallet_number: parsedData.palletNumber,
                        cases_on_pallet: parsedData.casesOnPallet,
                        actual_cases: actualCases,
                        stock_code: parsedData.stockCode,
                        description: parsedData.description,
                        raw_code: parsedData.raw,
                        device_id: DEVICE_ID,
                        scanned_by: userName,
                        session_type: sessionType,
                        expiry_date: parsedData.expiryDate || null,
                        location: locationPayload.location,
                        site: locationPayload.site,
                        aisle: locationPayload.aisle,
                        rack: locationPayload.rack,
                        unit_type: parsedData.unitType || (sessionType === 'RM' ? 'kg' : 'cases')
                    });
                    if (!result) {
                        await logClientEvent('scan-insert-failed', 'error', sessionId, { transport: 'netlify', batch: parsedData.batchNumber });
                        throw new Error('Failed to insert scan via Netlify Functions');
                    }
                    console.log('Insert result:', result);
                } else if (supabase && sessionId) {
                    // Handle UPDATE for duplicate pallet
                    if (isUpdate) {
                        console.log('Updating existing pallet scan:', parsedData.existingScanId);
                        try {
                            const { data, error } = await supabase
                                .from('stock_scans')
                                .update({
                                    actual_cases: actualCases,
                                    scanned_by: userName,
                                    device_id: DEVICE_ID,
                                    scanned_at: new Date().toISOString(),
                                    location: locationPayload.location,
                                    site: locationPayload.site,
                                    aisle: locationPayload.aisle,
                                    rack: locationPayload.rack
                                })
                                .eq('id', parsedData.existingScanId)
                                .select();
                            
                            if (error) {
                                console.error('Supabase update error:', error);
                                await logClientEvent('scan-update-failed', 'error', sessionId, { error: error.message, scanId: parsedData.existingScanId });
                                throw error;
                            }
                            
                            console.log('Updated pallet scan in Supabase:', data);
                            await logClientEvent('scan-update', 'info', sessionId, { scanId: parsedData.existingScanId, newCases: actualCases });
                        } catch (err) {
                            console.error('Failed to update scan in Supabase:', err);
                            await logClientEvent('scan-update-failed', 'error', sessionId, { message: err.message });
                            alert('Failed to update scan. Please check your connection.');
                            throw err;
                        }
                    } else {
                        // INSERT new scan
                        console.log('Saving to Supabase with sessionId:', sessionId);
                        try {
                            const record = {
                                session_id: sessionId,
                                take_date: this.currentTakeDate,
                                batch_number: parsedData.batchNumber,
                                stock_code: parsedData.stockCode,
                                description: parsedData.description,
                                scanned_by: userName,
                                device_id: DEVICE_ID,
                                session_type: sessionType,
                                location: locationPayload.location,
                                site: locationPayload.site,
                                aisle: locationPayload.aisle,
                                rack: locationPayload.rack,
                                unit_type: parsedData.unitType || (sessionType === 'RM' ? 'kg' : 'cases'),
                                actual_cases: actualCases,
                                pallet_number: parsedData.palletNumber || null,
                                cases_on_pallet: parsedData.casesOnPallet || null,
                                expiry_date: parsedData.expiryDate || null,
                                raw_code: parsedData.raw
                            };
                            
                            const { data, error } = await supabase
                                .from('stock_scans')
                                .insert([record])
                                .select();
                        
                            if (error) {
                                console.error('Supabase insert error:', error);
                                await logClientEvent('scan-insert-failed', 'error', sessionId, { error: error.message, record });
                                throw error;
                            }
                        
                            console.log('Saved to Supabase stock_scans:', data);
                            await logClientEvent('scan-insert', 'info', sessionId, { scanId: data?.[0]?.id || null });
                        } catch (err) {
                            console.error('Failed to save to Supabase:', err);
                            await logClientEvent('scan-insert-failed', 'error', sessionId, { message: err.message });
                            alert('Failed to save scan to database. Please check your connection.');
                            throw err;
                        }
                    }
                } else {
                    // Fallback to localStorage (offline mode)
                    console.log('Saving to localStorage (no session or Supabase not available)', { supabase: !!supabase, sessionId });
                    const scan = {
                        id: 'scan:' + Date.now(),
                        timestamp: Date.now(),
                        date: new Date().toLocaleDateString(),
                        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                        raw: parsedData.raw,
                        batchNumber: parsedData.batchNumber,
                        palletNumber: parsedData.palletNumber,
                        casesOnPallet: parsedData.casesOnPallet,
                        actualCases: actualCases,
                        scannedBy: userName,
                        stockCode: parsedData.stockCode,
                        description: parsedData.description,
                        valid: parsedData.valid,
                        deviceId: DEVICE_ID,
                        sessionType: sessionType,
                        expiryDate: parsedData.expiryDate || null,
                        isRawMaterial: parsedData.isRawMaterial || false,
                        location: locationPayload.location,
                        site: locationPayload.site,
                        aisle: locationPayload.aisle,
                        rack: locationPayload.rack,
                        unitType: parsedData.unitType || (sessionType === 'RM' ? 'kg' : 'cases')
                    };
                    
                    localStorage_db.set(scan.id, scan);
                }
                
                await this.loadScans();
                
                // Clear the pending scan key now that save is complete
                if (this.currentScan) {
                    const scanKey = this.getScanKey(this.currentScan);
                    this.pendingScanKeys.delete(scanKey);
                }
                
                this.currentScan = null;
                this.showingCaseEntry = false;
                this.triggerHaptic('success');
                this.render();
            }

            async deleteScan(id) {
                // Find the scan to show in confirmation
                const scan = this.scans.find(s => s.id === id);
                const scanInfo = scan ? `${scan.stockCode} - ${scan.description}` : 'this scan';
                
                // Use custom confirm dialog
                const confirmed = await new Promise(resolve => {
                    this.showModal({
                        title: 'Delete Scan',
                        message: `Are you sure you want to delete ${scanInfo}?`,
                        type: 'confirm',
                        confirmText: 'Delete',
                        cancelText: 'Cancel',
                        onConfirm: () => resolve(true),
                        onCancel: () => resolve(false)
                    });
                });
                
                if (!confirmed) return;
                
                if (this.useNeonDB) {
                    await db.deleteStockScan(id);
                } else if (supabase) {
                    // Delete from stock_scans table
                    try {
                        const { error } = await supabase
                            .from('stock_scans')
                            .delete()
                            .eq('id', id);
                        
                        if (error) {
                            console.error('Supabase delete error:', error);
                            await logClientEvent('scan-delete-failed', 'error', this.activeStockTake?.id || null, { scanId: id, message: error.message });
                            throw error;
                        }
                        
                        console.log('Deleted from stock_scans:', id);
                        await logClientEvent('scan-delete', 'warning', this.activeStockTake?.id || null, { scanId: id });
                    } catch (err) {
                        console.error('Failed to delete from Supabase:', err);
                        alert('Failed to delete scan from database.');
                        return;
                    }
                } else {
                    localStorage_db.delete(id);
                }
                
                // Remove from local scans array immediately
                this.scans = this.scans.filter(s => s.id !== id);
                this.triggerHaptic('heavy');
                this.render();
            }

            async submitCaseCount() {
                const input = document.getElementById('caseInput');
                const isKg = this.currentScan?.unitType === 'kg';
                const actualCases = isKg ? parseFloat(input.value) : parseInt(input.value);
                
                console.log('submitCaseCount called:', { value: input?.value, isKg, actualCases, currentScan: this.currentScan });
                
                if (isNaN(actualCases) || actualCases < 0) {
                    alert(isKg ? 'Please enter a valid weight in kg' : 'Please enter a valid quantity');
                    return;
                }

                const save = async () => {
                    console.log('save() called, about to call saveScan');
                    try {
                        await this.saveScan(this.currentScan, actualCases);
                        console.log('saveScan completed successfully');
                    } catch (err) {
                        console.error('Save scan error:', err);
                        alert('Failed to save scan. Please try again.');
                    }
                };

                if ((this.activeStockTake?.sessionType === 'RM' || this.currentScan?.isRawMaterial) && !this.currentScan?.expiryDate) {
                    console.log('RM scan without expiry - showing modal');
                    this.showModal({
                        title: 'Expiry Date Required',
                        message: 'Enter expiry date (YYYY-MM-DD) or leave blank:',
                        type: 'input',
                        confirmText: 'Continue',
                        onConfirm: (data) => {
                            console.log('Expiry modal onConfirm called:', data);
                            const manualExpiry = data.value;
                            if (manualExpiry && manualExpiry.trim() !== '') {
                                const parsedDate = new Date(manualExpiry.trim());
                                if (isNaN(parsedDate.getTime())) {
                                    alert('Invalid expiry date format. Please use YYYY-MM-DD.');
                                    return;
                                }
                                this.currentScan.expiryDate = parsedDate.toISOString().split('T')[0];
                                console.log('Calling save with expiry:', this.currentScan.expiryDate);
                                save();
                            } else {
                                console.log('No expiry entered - showing confirmation modal');
                                this.showModal({
                                    title: 'Confirm No Expiry',
                                    message: 'No expiry date will be recorded. Continue?',
                                    type: 'confirm',
                                    confirmText: 'Yes, Continue',
                                    cancelText: 'Go Back',
                                    onConfirm: () => {
                                        console.log('No-expiry confirmation - calling save');
                                        save();
                                    }
                                });
                            }
                        }
                    });
                    return;
                }
                
                await save();
            }

            cancelCaseEntry() {
                // Clear the pending scan key when cancelling
                if (this.currentScan) {
                    const scanKey = this.getScanKey(this.currentScan);
                    this.pendingScanKeys.delete(scanKey);
                }
                
                this.currentScan = null;
                this.showingCaseEntry = false;
                this.render();
            }

            async toggleSessionPause() {
                if (!this.activeStockTake?.id) return;
                const nextStatus = this.activeStockTake.status === 'paused' ? 'active' : 'paused';
                
                const processStatusChange = async (reason) => {
                    if (supabaseSessionsEnabled) {
                        await changeSessionStatusSupabase(this.activeStockTake, nextStatus, reason, {});
                    } else {
                        await updateSession(this.activeStockTake.date, this.activeStockTake.id, { status: nextStatus });
                    }
                    this.activeStockTake = { ...this.activeStockTake, status: nextStatus };
                    setActiveStockTake(this.activeStockTake);
                    if (nextStatus === 'paused') {
                        this.stopHeartbeat('paused');
                        this.triggerHaptic('warning');
                    } else {
                        if (supabaseSessionsEnabled) {
                            this.startHeartbeat('active');
                        }
                        this.triggerHaptic('success');
                    }
                    this.render();
                };

                if (nextStatus === 'paused') {
                    this.showModal({
                        title: 'Pause Session',
                        message: 'Reason for pausing (optional):',
                        type: 'input',
                        confirmText: 'Pause',
                        onConfirm: (data) => {
                            processStatusChange(data.value || 'Paused manually');
                        }
                    });
                } else {
                    await processStatusChange('Resumed manually');
                }
            }
            
            async selectExpiryDate(expiryDate) {
                if (!this.pendingScan) return;
                
                // Set the selected expiry date
                this.pendingScan.expiryDate = expiryDate;
                this.pendingScan.needsExpiryConfirmation = false;
                
                this.showingExpirySelection = false;
                
                // Continue with duplicate check and case entry
                const parsed = this.pendingScan;
                this.pendingScan = null;
                
                // Check for duplicate - include stock_code and expiry for RM
                const duplicate = await this.checkDuplicate(
                    parsed.batchNumber, 
                    parsed.palletNumber,
                    parsed.stockCode,
                    parsed.expiryDate
                );
                
                if (duplicate) {
                    const timestamp = duplicate.scanned_at || duplicate.created_at || duplicate.date + ' ' + duplicate.time;
                    const scannedByName = duplicate.scanned_by || duplicate.scannedBy || 'Unknown';
                    const deviceInfo = duplicate.device_id || duplicate.deviceId || '';
                    
                    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                    
                    const sessionType = this.activeStockTake?.sessionType || 'FP';
                    const itemLabel = sessionType === 'RM' ? 'item' : 'pallet';
                    
                    const rescan = confirm(
                        ` DUPLICATE SCAN DETECTED!\n\n` +
                        `Stock Code: ${parsed.stockCode}\n` +
                        `Batch: ${parsed.batchNumber}\n` +
                        (sessionType !== 'RM' ? `Pallet: ${parsed.palletNumber}\n` : '') +
                        (parsed.expiryDate ? `Expiry: ${parsed.expiryDate}\n` : '') +
                        `\nPreviously scanned by: ${scannedByName}\n` +
                        (deviceInfo ? `Device: ${deviceInfo}\n` : '') +
                        `at ${new Date(timestamp).toLocaleString()}\n\n` +
                        `Do you want to rescan this ${itemLabel}?`
                    );
                    
                    if (!rescan) {
                        this.render();
                        return;
                    }
                }
                
                this.currentScan = parsed;
                this.showingCaseEntry = true;
                this.render();
            }
            
            cancelExpirySelection() {
                this.pendingScan = null;
                this.showingExpirySelection = false;
                this.render();
            }

            manualEntry() {
                this.stopScanning();
                const sessionType = this.activeStockTake?.sessionType || 'FP';
                
                if (sessionType === 'FP') {
                    // FP: Allow entering 13-digit full code OR 5-digit batch code
                    this.showModal({
                        title: 'Type Code',
                        message: 'Enter 13-digit barcode OR 5-digit batch number:',
                        type: 'input',
                        confirmText: 'Process',
                        onConfirm: (data) => {
                            const code = (data.value || '').trim();
                            if (!code) return;
                            
                            // Check if it's a full 13-digit code
                            if (/^\d{13}$/.test(code)) {
                                // Process as normal barcode
                                this.onScanSuccess(code);
                                return;
                            }
                            
                            // Check if it's a 5-digit batch code
                            if (/^\d{5}$/.test(code)) {
                                // Lookup product in database
                                const productInfo = productDatabase[code];
                                if (!productInfo || productInfo.stockCode === 'UNKNOWN') {
                                    alert(`Product not found for batch code: ${code}\n\nPlease check the code or add it to the product database.`);
                                    return;
                                }
                                
                                // Product found - now ask for number of cases
                                this.showModal({
                                    title: 'Enter Case Count',
                                    message: `Product: ${productInfo.stockCode}\n${productInfo.description}\n\nEnter number of cases:`,
                                    type: 'input',
                                    confirmText: 'Save',
                                    onConfirm: (caseData) => {
                                        const cases = parseInt(caseData.value, 10);
                                        if (isNaN(cases) || cases < 0) {
                                            alert('Please enter a valid number of cases');
                                            return;
                                        }
                                        
                                        // Create a manual entry scan object
                                        const manualScan = {
                                            valid: true,
                                            raw: `MANUAL:${code}`,
                                            batchNumber: code,
                                            palletNumber: 'MANUAL',
                                            casesOnPallet: cases,
                                            stockCode: productInfo.stockCode,
                                            description: productInfo.description,
                                            isManualEntry: true
                                        };
                                        
                                        // Save the scan directly
                                        this.saveScan(manualScan, cases).then(() => {
                                            // Show success feedback
                                            if (navigator.vibrate) navigator.vibrate(200);
                                        }).catch(err => {
                                            console.error('Failed to save manual entry:', err);
                                            alert('Failed to save. Please try again.');
                                        });
                                    }
                                });
                                return;
                            }
                            
                            // Invalid format
                            alert('Please enter either:\n 13 digits (full barcode)\n 5 digits (batch code only)');
                        }
                    });
                } else {
                    // RM: Keep existing behavior - enter full code
                    this.showModal({
                        title: 'Manual Entry',
                        message: 'Enter the QR code manually:',
                        type: 'input',
                        confirmText: 'Process',
                        onConfirm: (data) => {
                            if (data.value && data.value.trim()) {
                                this.onScanSuccess(data.value.trim());
                            }
                        }
                    });
                }
            }

            showProductDatabase() {
                // Show appropriate database based on session type
                if (this.activeStockTake?.sessionType === 'RM') {
                    this.showingRMProductDB = true;
                } else {
                    this.showingProductDB = true;
                }
                this.render();
            }

            hideProductDatabase() {
                this.showingProductDB = false;
                this.showingRMProductDB = false;
                this.render();
            }

            showSettings() {
                this.showingStartStockTake = false;
                this.showingSettings = true;
                this.render();
            }

            hideSettings() {
                this.showingSettings = false;
                this.showingStartStockTake = true;
                this.refreshSessionsFromSupabase(); // Refresh sessions when returning to start screen
                this.render();
            }

            goHome() {
                // Stop current session activities but don't end the session
                this.stopAutoSync();
                this.stopHeartbeat();
                clearActiveStockTake();
                this.activeStockTake = null;
                this.scans = [];
                this.selectedStockTakeType = null;
                this.showingStartStockTake = true;
                this.refreshSessionsFromSupabase(); // Refresh sessions when going home
                this.render();
            }

            // Session History Methods
            showSessionHistory() {
                this.showingStartStockTake = false;
                this.showingSessionHistory = true;
                this.loadAvailableSessions();
                this.render();
            }

            hideSessionHistory() {
                this.showingSessionHistory = false;
                this.historyDate = null;
                this.historySessions = [];
                this.historyScans = [];
                this.showingStartStockTake = true;
                this.render();
            }

            async loadAvailableSessions() {
                // Get all unique sessions from localStorage
                const allSessions = [];
                const seenSessionIds = new Set();
                const activeSessionIds = new Set();
                const today = new Date().toLocaleDateString('en-CA');
                
                // First, get the current active session from activeStockTake
                const activeStockTake = getActiveStockTake();
                if (activeStockTake && activeStockTake.id) {
                    activeSessionIds.add(activeStockTake.id);
                }
                
                // Also check for any sessions stored with 'active' status in localStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('stocktake_')) {
                        try {
                            const session = JSON.parse(localStorage.getItem(key));
                            if (session && session.id && session.status === 'active') {
                                activeSessionIds.add(session.id);
                            }
                        } catch (e) {
                            // Ignore parsing errors for this check
                        }
                    }
                }
                
                // Now load all sessions from localStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('stocktake_')) {
                        try {
                            const session = JSON.parse(localStorage.getItem(key));
                            if (session && session.id && !seenSessionIds.has(session.id)) {
                                seenSessionIds.add(session.id);
                                // Determine if session is active
                                const isActive = activeSessionIds.has(session.id);
                                allSessions.push({
                                    id: session.id,
                                    date: session.date,
                                    sessionType: session.sessionType || 'FP',
                                    device: session.device || 'Unknown',
                                    startTime: session.startTime,
                                    endTime: session.endTime,
                                    status: isActive ? 'active' : (session.status || 'completed')
                                });
                            }
                        } catch (e) {
                            console.error('Error parsing session:', e);
                        }
                    }
                }
                
                // Also load sessions from Supabase if available
                if (supabase && this.isBrowserOnline) {
                    try {
                        // Get distinct sessions from stock_scans table
                        const { data, error } = await supabase
                            .from('stock_scans')
                            .select('session_id, session_type, scanned_at, device_id')
                            .order('scanned_at', { ascending: false });
                        
                        if (!error && data) {
                            // Group by session_id to get unique sessions
                            const sessionMap = new Map();
                            data.forEach(scan => {
                                if (scan.session_id && !sessionMap.has(scan.session_id) && !seenSessionIds.has(scan.session_id)) {
                                    const scanDate = new Date(scan.scanned_at);
                                    const sessionDate = scanDate.toLocaleDateString('en-CA');
                                    // Check if this is an active session
                                    const isActive = activeSessionIds.has(scan.session_id);
                                    sessionMap.set(scan.session_id, {
                                        id: scan.session_id,
                                        date: sessionDate,
                                        sessionType: scan.session_type || 'FP',
                                        device: scan.device_id || 'Unknown',
                                        startTime: scanDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                                        status: isActive ? 'active' : 'completed'
                                    });
                                    seenSessionIds.add(scan.session_id);
                                }
                            });
                            
                            // Add Supabase sessions to the list
                            sessionMap.forEach(session => allSessions.push(session));
                        }
                    } catch (e) {
                        console.error('Error loading sessions from Supabase:', e);
                    }
                }
                
                // Sort by date descending, with active sessions first
                allSessions.sort((a, b) => {
                    // Active sessions come first
                    if (a.status === 'active' && b.status !== 'active') return -1;
                    if (b.status === 'active' && a.status !== 'active') return 1;
                    const dateCompare = (b.date || '').localeCompare(a.date || '');
                    if (dateCompare !== 0) return dateCompare;
                    return (b.startTime || '').localeCompare(a.startTime || '');
                });
                
                this.historySessions = allSessions;
                this.render(); // Re-render after loading sessions
            }

            async loadSessionHistory(sessionId) {
                // Find the session first
                const session = this.historySessions.find(s => s.id === sessionId);
                if (!session) {
                    alert('Session not found');
                    return;
                }
                
                // Set session and show loading state immediately (don't clear scans yet)
                this.selectedHistorySession = session;
                this.historyLoading = true;
                this.render(); // Show loading indicator immediately
                
                if (!supabase) {
                    this.historyLoading = false;
                    this.historyScans = [];
                    alert('Session history requires Supabase connectivity.');
                    this.render();
                    return;
                }

                if (!this.isBrowserOnline) {
                    this.historyLoading = false;
                    this.historyScans = [];
                    alert('Session history is unavailable while offline.');
                    this.render();
                    return;
                }

                try {
                    const { data, error } = await supabase
                        .from('stock_scans')
                        .select('id,batch_number,stock_code,description,actual_cases,pallet_number,location,site,aisle,rack,expiry_date,unit_type,scanned_at,scanned_by')
                        .eq('session_id', sessionId)
                        .order('scanned_at', { ascending: true });
                    
                    if (error) throw error;
                    
                    this.historyScans = (data || []).map(item => ({
                        id: item.id,
                        batchNumber: item.batch_number,
                        stockCode: item.stock_code,
                        description: item.description,
                        cases: item.actual_cases,
                        palletNumber: item.pallet_number,
                        location: item.location,
                        site: item.site,
                        aisle: item.aisle,
                        rack: item.rack,
                        expiryDate: item.expiry_date,
                        unitType: item.unit_type || (session.sessionType === 'RM' ? 'kg' : 'cases'),
                        timestamp: item.scanned_at,
                        scannedBy: item.scanned_by
                    }));
                } catch (error) {
                    console.error('Error loading history scans:', error);
                    await logClientEvent('history-load-failed', 'error', sessionId, { message: error.message });
                    this.historyScans = [];
                    alert('Error loading session scans. Check console for details.');
                }
                
                this.historyLoading = false;
                this.render();
            }

            exportHistorySession() {
                if (!this.selectedHistorySession || this.historyScans.length === 0) {
                    alert('No session data to export');
                    return;
                }
                
                const session = this.selectedHistorySession;
                
                // Prepare export data
                const exportData = this.historyScans.map(scan => {
                    const base = {
                        'Stock Code': scan.stockCode,
                        'Description': scan.description,
                        'Batch Number': scan.batchNumber
                    };
                    
                    if (session.sessionType === 'RM') {
                        base['Quantity'] = scan.cases;
                        base['Unit'] = scan.unitType === 'kg' ? 'kg' : 'units';
                        base['Location'] = scan.location || '';
                        base['Expiry Date'] = scan.expiryDate || '';
                    } else {
                        base['Cases'] = scan.cases;
                        base['Pallet Number'] = scan.palletNumber || '';
                        base['Location'] = scan.location || '';
                    }
                    base['Site'] = scan.site || '';
                    base['Aisle'] = scan.aisle || '';
                    base['Rack'] = scan.rack || '';
                    
                    base['Scanned By'] = scan.scannedBy || '';
                    base['Timestamp'] = new Date(scan.timestamp).toLocaleString();
                    
                    return base;
                });
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);
                XLSX.utils.book_append_sheet(wb, ws, 'Stock Count');
                
                // Generate filename
                const sessionTypeLabel = session.sessionType === 'RM' ? 'RawMaterials' : 'FinishedProducts';
                const filename = `StockCount_${sessionTypeLabel}_${session.date}_${session.id.slice(-6)}.xlsx`;
                
                // Download
                XLSX.writeFile(wb, filename);
            }

            async saveSettings() {
                alert('Database credentials are configured. Use Test Connection to verify.');
            }

            async testConnection() {
                const connected = await db.init();
                
                if (connected) {
                    await this.ensureStockTake();
                    await this.loadScans();
                    if (!this.syncInterval) {
                        this.startAutoSync();
                    }
                    const modeLabel = db.mode === 'supabase' ? 'Supabase' : (db.mode === 'netlify' ? 'Neon DB' : 'local cache');
                    if (db.mode === 'localStorage') {
                        alert('Connected in offline mode. Data will sync once Supabase is reachable.');
                    } else {
                        alert(` Connected to ${modeLabel} successfully!`);
                    }
                } else {
                    alert(' Connection failed. Check browser console for details.');
                }
                
                this.render();
            }

            addProduct() {
                this.showModal({
                    title: 'Add New Product',
                    type: 'form',
                    fields: [
                        { name: 'batch', label: 'Batch Number', placeholder: '5 digits', required: true },
                        { name: 'stockCode', label: 'Stock Code', placeholder: 'e.g. FP123', required: true },
                        { name: 'description', label: 'Description', placeholder: 'Product name', required: true }
                    ],
                    confirmText: 'Add Product',
                    onConfirm: async (data) => {
                        const { batch, stockCode, description } = data;
                        if (!/^\d{5}$/.test(batch)) {
                            alert('Invalid batch number (must be 5 digits)');
                            return;
                        }
                        
                        productDatabase[batch] = { stockCode, description };
                        saveProductDatabase();
                        
                        await addProductToSupabase(batch, stockCode, description);
                        
                        this.showModal({
                            title: 'Success',
                            message: 'Product added successfully!',
                            type: 'alert'
                        });
                    }
                });
            }
            
            addRawMaterial() {
                this.showModal({
                    title: 'Add Raw Material',
                    type: 'form',
                    fields: [
                        { name: 'stockCode', label: 'Stock Code', placeholder: 'Starts with letter', required: true },
                        { name: 'description', label: 'Description', placeholder: 'Material name', required: true },
                        { name: 'batchNumber', label: 'Batch Number (Optional)', placeholder: 'e.g. B123', required: false },
                        { name: 'expiryDate', label: 'Expiry Date (Optional)', placeholder: 'YYYY-MM-DD', type: 'date', required: false }
                    ],
                    confirmText: 'Add Material',
                    onConfirm: async (data) => {
                        const { stockCode, description, batchNumber, expiryDate } = data;
                        
                        if (!/^[A-Za-z]/.test(stockCode)) {
                            alert('Invalid stock code - must start with a letter');
                            return;
                        }
                        
                        // Add to database
                        if (!rawMaterialsDatabase[stockCode]) {
                            rawMaterialsDatabase[stockCode] = { description, batches: {} };
                        }
                        if (batchNumber) {
                            rawMaterialsDatabase[stockCode].batches[batchNumber] = { expiryDate: expiryDate || null };
                        }
                        rawMaterialsDatabase[stockCode].description = description;
                        
                        saveRawMaterialsDatabase();
                        
                        await addRawMaterialToSupabase(stockCode, description, batchNumber, expiryDate);
                        
                        this.showModal({
                            title: 'Success',
                            message: 'Raw Material added successfully!',
                            type: 'alert'
                        });
                    }
                });
            }

            async refreshProductsFromCloud() {
                if (!supabase) {
                    alert('Cloud sync not available');
                    return;
                }
                
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="animate-spin"></span> Loading...';
                btn.disabled = true;
                
                try {
                    if (this.activeStockTake?.sessionType === 'RM') {
                        const loaded = await loadRawMaterialsFromSupabase();
                        if (loaded) {
                            alert(`Loaded ${Object.keys(rawMaterialsDatabase).length} raw materials from Supabase`);
                        } else {
                            alert('No raw materials found in Supabase or error occurred');
                        }
                    } else {
                        const loaded = await loadProductsFromSupabase();
                        if (loaded) {
                            alert(`Loaded ${Object.keys(productDatabase).length} products from Supabase`);
                        } else {
                            alert('No products found in Supabase or error occurred');
                        }
                    }
                } catch (err) {
                    alert('Error loading products: ' + err.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
                this.render();
            }
            
            clearRMDatabase() {
                this.showModal({
                    title: 'Clear Raw Materials',
                    message: 'Are you sure you want to clear all raw materials? This cannot be undone.',
                    type: 'confirm',
                    confirmText: 'Clear',
                    cancelText: 'Cancel',
                    onConfirm: () => {
                        rawMaterialsDatabase = {};
                        saveRawMaterialsDatabase();
                        this.render();
                    }
                });
            }

            uploadExcel() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xlsx,.xls,.csv';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = new Uint8Array(event.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                            
                            let imported = 0;
                            jsonData.forEach(row => {
                                const batch = String(row.BatchNumber || row.batchNumber || row['Batch Number'] || '').padStart(5, '0');
                                const stockCode = row.StockCode || row.stockCode || row['Stock Code'];
                                const description = row.Description || row.description;
                                
                                if (batch && stockCode && description && /^\d{5}$/.test(batch)) {
                                    productDatabase[batch] = { stockCode, description };
                                    imported++;
                                }
                            });
                            
                            saveProductDatabase();
                            alert(`Imported ${imported} products!`);
                            this.render();
                        } catch (err) {
                            alert('Error: ' + err.message);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                };
                input.click();
            }
            
            uploadRMExcel() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xlsx,.xls,.csv';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = new Uint8Array(event.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                            
                            let imported = 0;
                            jsonData.forEach(row => {
                                const stockCode = row.StockCode || row.stockCode || row['Stock Code'] || row.stock_code;
                                const description = row.Description || row.description || row['Stock Description'] || '';
                                const batchNumber = row.BatchNumber || row.batchNumber || row['Batch Number'] || row.batch_number || '';
                                const expiryDate = row.ExpiryDate || row.expiryDate || row['Expiry Date'] || row.expiry_date || null;
                                
                                if (stockCode) {
                                    if (!rawMaterialsDatabase[stockCode]) {
                                        rawMaterialsDatabase[stockCode] = { description, batches: {} };
                                    }
                                    if (description) {
                                        rawMaterialsDatabase[stockCode].description = description;
                                    }
                                    if (batchNumber) {
                                        rawMaterialsDatabase[stockCode].batches[batchNumber] = { 
                                            expiryDate: expiryDate || null 
                                        };
                                    }
                                    imported++;
                                }
                            });
                            
                            saveRawMaterialsDatabase();
                            alert(`Imported ${imported} raw materials!`);
                            this.render();
                        } catch (err) {
                            alert('Error: ' + err.message);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                };
                input.click();
            }

            exportProductDatabase() {
                const data = Object.entries(productDatabase).map(([batch, info]) => ({
                    BatchNumber: batch,
                    StockCode: info.stockCode,
                    Description: info.description
                }));
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Products");
                XLSX.writeFile(wb, "product_database.xlsx");
            }
            
            exportRMDatabase() {
                const data = [];
                Object.entries(rawMaterialsDatabase).forEach(([stockCode, info]) => {
                    if (Object.keys(info.batches || {}).length === 0) {
                        data.push({
                            StockCode: stockCode,
                            Description: info.description,
                            BatchNumber: '',
                            ExpiryDate: ''
                        });
                    } else {
                        Object.entries(info.batches).forEach(([batch, batchInfo]) => {
                            data.push({
                                StockCode: stockCode,
                                Description: info.description,
                                BatchNumber: batch,
                                ExpiryDate: batchInfo.expiryDate || ''
                            });
                        });
                    }
                });
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Raw Materials");
                XLSX.writeFile(wb, "raw_materials_database.xlsx");
            }

            exportStockCount() {
                const data = this.scans.map(scan => ({
                    'Stock Take Date': this.currentTakeDate,
                    'Scanned By': scan.scannedBy || 'Unknown',
                    'Batch Number': scan.batchNumber,
                    'Pallet Number': scan.palletNumber,
                    'Stock Code': scan.stockCode,
                    'Description': scan.description,
                    'Cases on Pallet': scan.casesOnPallet,
                    'Actual Cases': scan.actualCases,
                    'Variance': scan.actualCases - scan.casesOnPallet,
                    'Site': scan.site || '',
                    'Aisle': scan.aisle || '',
                    'Rack': scan.rack || '',
                    'Location Notes': scan.location || '',
                    'Scanned At': scan.date + ' ' + scan.time,
                    'Device ID': scan.deviceId,
                    'Raw QR Code': scan.raw
                }));
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Stock Count");
                
                const filename = `stock_count_${this.currentTakeDate}.xlsx`;
                XLSX.writeFile(wb, filename);
            }

            clearDatabase() {
                this.showModal({
                    title: 'Clear Database',
                    message: 'Are you sure you want to clear the entire product database?',
                    type: 'confirm',
                    confirmText: 'Clear',
                    cancelText: 'Cancel',
                    onConfirm: () => {
                        productDatabase = {};
                        saveProductDatabase();
                        this.showModal({ title: 'Success', message: 'Database cleared', type: 'alert' });
                        this.render();
                    }
                });
            }

            showModal(config) {
                this.modalState = {
                    title: config.title || 'Alert',
                    message: config.message || '',
                    type: config.type || 'alert', // alert, confirm, input, form
                    fields: config.fields || [], // [{name, label, type, value, placeholder, required}]
                    confirmText: config.confirmText || 'OK',
                    cancelText: config.cancelText || 'Cancel',
                    onConfirm: config.onConfirm || (() => {}),
                    onCancel: config.onCancel || (() => {})
                };
                this.render();
                
                // Focus first input if applicable
                setTimeout(() => {
                    const firstInput = document.querySelector('#modal-content input');
                    if (firstInput) firstInput.focus();
                }, 100);
            }

            closeModal() {
                this.modalState = null;
                this.render();
            }

            handleModalSubmit(e) {
                e.preventDefault();
                if (!this.modalState) return;
                
                const formData = {};
                if (this.modalState.type === 'input') {
                    const input = document.getElementById('modal-input');
                    formData.value = input ? input.value : '';
                } else if (this.modalState.type === 'form') {
                    this.modalState.fields.forEach(field => {
                        const input = document.getElementById(`modal-field-${field.name}`);
                        if (input) {
                            formData[field.name] = field.type === 'checkbox' ? input.checked : input.value;
                        }
                    });
                }
                
                // Save the callback before closing modal (in case callback shows a new modal)
                const onConfirmCallback = this.modalState.onConfirm;
                this.modalState = null; // Clear modal state first
                
                if (onConfirmCallback) {
                    onConfirmCallback(formData);
                }
                
                // Only render if no new modal was opened
                if (!this.modalState) {
                    this.render();
                }
            }

            renderModal() {
                const root = document.getElementById('modal-root');
                if (!this.modalState) {
                    root.innerHTML = '';
                    return;
                }
                
                const { title, message, type, fields, confirmText, cancelText } = this.modalState;
                
                let content = '';
                
                if (type === 'input') {
                    content = `
                        <input type="text" id="modal-input" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-50/50 outline-none transition-all" placeholder="Enter value" autocomplete="off">
                    `;
                } else if (type === 'form') {
                    content = fields.map(field => `
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-slate-700 mb-2">${field.label}</label>
                            ${field.type === 'checkbox' ? `
                                <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-xl bg-slate-50">
                                    <input type="checkbox" id="modal-field-${field.name}" ${field.value ? 'checked' : ''} class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                                    <span class="text-slate-700 font-medium">${field.placeholder || ''}</span>
                                </label>
                            ` : `
                                <input 
                                    type="${field.type || 'text'}" 
                                    id="modal-field-${field.name}" 
                                    value="${field.value || ''}" 
                                    class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-50/50 outline-none transition-all" 
                                    placeholder="${field.placeholder || ''}"
                                    ${field.required ? 'required' : ''}
                                >
                            `}
                        </div>
                    `).join('');
                } else if (type === 'loading') {
                    content = `
                        <div class="flex flex-col items-center justify-center py-4">
                            <div class="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
                            <p class="text-slate-600 font-medium">${message || 'Loading...'}</p>
                        </div>
                    `;
                }
                
                root.innerHTML = `
                    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in" style="z-index: 9999;">
                        <div class="bg-white rounded-2xl sm:rounded-3xl shadow-2xl w-full max-w-sm sm:max-w-md overflow-hidden transform transition-all scale-100">
                            <div class="p-4 sm:p-6">
                                ${type !== 'loading' ? `<h3 class="text-lg sm:text-xl font-bold text-slate-900 mb-2">${title}</h3>` : ''}
                                ${message && type !== 'loading' ? `<p class="text-sm sm:text-base text-slate-500 mb-4 sm:mb-6">${message}</p>` : ''}
                                
                                <form id="modal-form" onsubmit="app.handleModalSubmit(event)">
                                    <div id="modal-content" class="mb-4 sm:mb-6">
                                        ${content}
                                    </div>
                                    
                                    ${type !== 'loading' ? `
                                    <div class="flex gap-2 sm:gap-3">
                                        ${type !== 'alert' ? `
                                            <button type="button" onclick="app.closeModal()" class="flex-1 py-2.5 sm:py-3 px-4 bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm sm:text-base font-bold rounded-xl transition-colors">
                                                ${cancelText}
                                            </button>
                                        ` : ''}
                                        <button type="submit" class="flex-1 py-2.5 sm:py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white text-sm sm:text-base font-bold rounded-xl shadow-lg shadow-blue-200 transition-all">
                                            ${confirmText}
                                        </button>
                                    </div>
                                    ` : ''}
                                </form>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Optimized render with debouncing to prevent excessive DOM updates
            render() {
                // Skip if render is already scheduled
                if (this._renderScheduled) return;
                
                // Debounce rapid render calls
                const now = performance.now();
                const timeSinceLastRender = now - this._lastRenderTime;
                
                if (timeSinceLastRender < this._renderDebounceMs) {
                    this._renderScheduled = true;
                    requestAnimationFrame(() => {
                        this._renderScheduled = false;
                        this._executeRender();
                    });
                    return;
                }
                
                this._executeRender();
            }
            
            _executeRender() {
                this._lastRenderTime = performance.now();
                this.renderModal();
                const scrollY = window.scrollY;
                const app = document.getElementById('app');
                
                const updateView = (html) => {
                    app.innerHTML = html;
                    // Restore scroll position if we are in the main list view
                    // (heuristic: if we are not showing a modal or special screen)
                    if (!this.showingStartStockTake && !this.showingSettings && !this.showingProductDB && !this.showingRMProductDB && !this.showingSessionHistory) {
                         window.scrollTo(0, scrollY);
                    } else {
                        window.scrollTo(0, 0);
                    }
                };

                if (this.isScanning && document.getElementById('scanner-view')) {
                    return;
                }
                // Note: Session refresh moved to explicit calls only to avoid blocking render
                
                // Start Stock Take Screen - Step 1: Type Selection
                if (this.showingStartStockTake && !this.selectedStockTakeType) {
                    const savedName = getUserName();
                    
                    updateView(`
                        <div class="min-h-screen flex flex-col bg-white">
                            <div class="flex-1 flex flex-col items-center justify-center p-4 sm:p-8">
                                <div class="w-full max-w-lg mx-auto">
                                    <div class="flex flex-col items-center mb-8">
                                        <div class="w-20 h-20 sm:w-24 sm:h-24 bg-gradient-to-br from-blue-500 to-blue-600 rounded-3xl flex items-center justify-center mb-6 sm:mb-8 shadow-lg shadow-blue-200 transform -rotate-6">
                                            <svg class="w-10 h-10 sm:w-12 sm:h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                                            </svg>
                                        </div>
                                        
                                        <h1 class="text-2xl sm:text-3xl font-bold text-slate-900">Stock Intelligence</h1>
                                    </div>
                                    
                                    <div class="w-full space-y-5">
                                        <!-- Name Input Field -->
                                        <div>
                                            <label class="block text-sm font-bold text-slate-700 mb-2 text-center">
                                                Your Name
                                            </label>
                                            <input 
                                                type="text" 
                                                id="userNameInput" 
                                                value="${savedName}"
                                                placeholder="Enter your name"
                                                onchange="setUserName(this.value)"
                                                class="w-full px-4 py-3 text-center text-lg font-medium border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all"
                                            />
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-bold text-slate-700 mb-3 text-center">
                                                Stock Count Type
                                            </label>
                                            <div class="grid grid-cols-2 gap-4">
                                            <button 
                                                onclick="app.selectStockTakeType('FP', document.getElementById('userNameInput').value)"
                                                class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 active:scale-[0.98] text-white p-4 sm:p-5 rounded-2xl text-xl sm:text-2xl font-bold shadow-lg shadow-blue-200 transition-all flex items-center justify-center hover-lift"
                                            >
                                                FP
                                            </button>
                                            <button 
                                                onclick="app.selectStockTakeType('RM', document.getElementById('userNameInput').value)"
                                                class="bg-gradient-to-r from-teal-600 to-teal-700 hover:from-teal-700 hover:to-teal-800 active:scale-[0.98] text-white p-4 sm:p-5 rounded-2xl text-xl sm:text-2xl font-bold shadow-lg shadow-teal-200 transition-all flex items-center justify-center hover-lift"
                                            >
                                                RM
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                </div>
                            </div>
                            
                            <!-- Quick Actions -->
                            <div class="p-4 sm:p-6 pt-0">
                                <div class="max-w-lg mx-auto">
                                    <div class="flex gap-3 justify-center">
                                        <button onclick="app.showSessionHistory()" class="w-12 h-12 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-full transition-colors flex items-center justify-center hover-lift" title="History">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                        </button>
                                        <button onclick="app.showSettings()" class="w-12 h-12 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-full transition-colors flex items-center justify-center hover-lift" title="Settings">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="p-4 sm:p-6 pt-0 text-center">
                                ${supabase && this.isBrowserOnline ? `
                                    <div class="inline-flex items-center gap-2 px-4 py-2 bg-green-50 text-green-700 rounded-full text-xs font-bold border border-green-100">
                                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                        <span>Connected to Supabase</span>
                                    </div>
                                ` : this.useNeonDB ? `
                                    <div class="inline-flex items-center gap-2 px-4 py-2 bg-green-50 text-green-700 rounded-full text-xs font-bold border border-green-100">
                                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                        <span>Connected to Neon DB</span>
                                    </div>
                                ` : `
                                    <div class="inline-flex items-center gap-2 px-4 py-2 bg-slate-100 text-slate-600 rounded-full text-xs font-bold border border-slate-200">
                                        <div class="w-2 h-2 bg-slate-400 rounded-full"></div>
                                        <span>Offline Mode</span>
                                    </div>
                                `}
                                <p class="text-xs text-slate-400 mt-4">v1.0.0  ${this.currentTakeDate}</p>
                            </div>
                        </div>
                    `);
                    return;
                }
                
                // Start Stock Take Screen - Step 2: Session Selection
                if (this.showingStartStockTake && this.selectedStockTakeType) {
                    const savedName = getUserName();
                    const sessionType = this.selectedStockTakeType;
                    const isRM = sessionType === 'RM';
                    const activeSessions = getActiveSessionsForDate(this.currentTakeDate).filter(s => s.sessionType === sessionType);
                    
                    updateView(`
                        <div class="min-h-screen flex flex-col bg-white pb-24">
                            <!-- Header -->
                            <div class="p-4 border-b border-slate-100">
                                <div class="max-w-2xl mx-auto">
                                    <button onclick="app.selectedStockTakeType = null; app.render();" class="flex items-center gap-2 text-slate-600 hover:text-slate-900 transition-colors">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                        </svg>
                                        <span class="font-medium text-sm sm:text-base">Back to Type Selection</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex-1 flex flex-col p-4 sm:p-6">
                                <div class="max-w-2xl mx-auto w-full">
                                    <div class="flex items-center gap-3 sm:gap-4 mb-6">
                                        <div class="w-12 h-12 sm:w-16 sm:h-16 ${isRM ? 'bg-gradient-to-br from-teal-500 to-teal-600' : 'bg-gradient-to-br from-blue-600 to-blue-700'} rounded-xl sm:rounded-2xl flex items-center justify-center shadow-lg ${isRM ? 'shadow-teal-200' : 'shadow-blue-200'}">
                                            ${isRM ? `
                                                <svg class="w-6 h-6 sm:w-8 sm:h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                                                </svg>
                                            ` : `
                                                <svg class="w-6 h-6 sm:w-8 sm:h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                                </svg>
                                            `}
                                        </div>
                                        <div>
                                            <h1 class="text-xl sm:text-2xl font-bold text-slate-900">${isRM ? 'Raw Materials' : 'Finished Products'}</h1>
                                            <p class="text-sm sm:text-base text-slate-500">Select or start a session</p>
                                        </div>
                                    </div>
                                
                                ${activeSessions.length > 0 ? `
                                    <!-- Active Sessions -->
                                    <div class="mb-6">
                                        <label class="block text-sm font-bold text-slate-700 mb-3">
                                            Active ${isRM ? 'RM' : 'FP'} Sessions
                                        </label>
                                        <div class="space-y-3">
                                            ${activeSessions.map(session => {
                                                const activeCount = session.devices?.filter(d => d.status === 'active').length || 0;
                                                const completedCount = session.devices?.filter(d => d.status === 'completed').length || 0;
                                                const sessionDate = session.startedAt ? new Date(session.startedAt).toLocaleDateString() : session.date || '';
                                                const sessionTime = session.startedAt ? new Date(session.startedAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                                                return `
                                                    <div class="p-4 border-2 ${isRM ? 'border-teal-200' : 'border-blue-200'} rounded-2xl">
                                                        <div class="flex items-center justify-between mb-2">
                                                            <div class="flex items-center gap-2">
                                                                <span class="px-3 py-1 text-sm font-bold ${isRM ? 'bg-teal-100 text-teal-700' : 'bg-blue-100 text-blue-700'} rounded-full">
                                                                    Session #${session.sessionNumber}
                                                                </span>
                                                                <span class="text-slate-600">by ${session.startedBy}</span>
                                                            </div>
                                                        </div>
                                                        <div class="flex items-center gap-4 text-sm mb-3">
                                                            <div class="flex items-center gap-1 text-emerald-600">
                                                                <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                                                                <span>${activeCount} active</span>
                                                            </div>
                                                            ${completedCount > 0 ? `
                                                                <div class="flex items-center gap-1 text-slate-400">
                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                                    </svg>
                                                                    <span>${completedCount} done</span>
                                                                </div>
                                                            ` : ''}
                                                            <div class="flex items-center gap-1 text-slate-400">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                                                </svg>
                                                                <span>${sessionDate} ${sessionTime}</span>
                                                            </div>
                                                        </div>
                                                        <div class="flex gap-2">
                                                            <button 
                                                                onclick="app.joinExistingSession('${session.id}', '${savedName}')"
                                                                class="flex-1 py-2 px-4 ${isRM ? 'bg-teal-600 hover:bg-teal-700' : 'bg-blue-600 hover:bg-blue-700'} text-white font-bold rounded-xl transition-colors text-sm"
                                                            >
                                                                Join Session
                                                            </button>
                                                            <button 
                                                                onclick="app.endSessionFromList('${session.id}')"
                                                                class="py-2 px-4 bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold rounded-xl transition-colors text-sm"
                                                            >
                                                                End
                                                            </button>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : `
                                    <div class="mb-6 p-4 sm:p-6 bg-slate-50 rounded-xl sm:rounded-2xl text-center">
                                        <svg class="w-10 h-10 sm:w-12 sm:h-12 mx-auto text-slate-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                        </svg>
                                        <p class="text-sm sm:text-base text-slate-500">No active ${isRM ? 'RM' : 'FP'} sessions today</p>
                                        <p class="text-xs sm:text-sm text-slate-400">Start a new session below</p>
                                    </div>
                                `}
                                </div>
                            </div>
                            
                            <div class="p-4 sm:p-6 text-center border-t border-slate-100">
                                <p class="text-xs text-slate-400">${this.currentTakeDate}</p>
                            </div>
                            
                            <!-- Floating Start New Session Button - Bottom Right -->
                            <button 
                                onclick="app.startNewStockTake('${savedName}', '${sessionType}')"
                                class="fixed bottom-6 right-6 ${isRM ? 'bg-teal-600 hover:bg-teal-700 shadow-teal-200' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200'} text-white px-5 py-3 rounded-full shadow-xl transition-all flex items-center gap-2 font-bold text-sm z-40"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                                New Session
                            </button>
                        </div>
                    `);
                    return;
                }
                
                if (this.isScanning) {
                    updateView(`
                        <div id="scanner-view" class="fixed inset-0 bg-black z-50 flex flex-col">
                            <!-- Scanner Header -->
                            <div class="absolute top-0 left-0 right-0 z-10 p-4 flex justify-between items-start bg-gradient-to-b from-black/50 to-transparent">
                                <button onclick="app.stopScanning()" class="bg-white/20 backdrop-blur-md text-white p-3 rounded-full hover:bg-white/30 transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                                <button onclick="app.manualEntry()" class="bg-white/20 backdrop-blur-md text-white px-4 py-2 rounded-full hover:bg-white/30 transition-colors text-sm font-medium">
                                    Type Code
                                </button>
                            </div>

                            <!-- Scanner Viewport -->
                            <div class="flex-1 relative overflow-hidden bg-black">
                                <div id="scanner" class="w-full h-full absolute inset-0"></div>
                                
                                <!-- Overlay Guide -->
                                <div class="absolute inset-0 pointer-events-none flex items-center justify-center">
                                    <div class="w-64 h-64 border-2 border-white/50 rounded-3xl relative">
                                        <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-blue-500 rounded-tl-xl -mt-1 -ml-1"></div>
                                        <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-blue-500 rounded-tr-xl -mt-1 -mr-1"></div>
                                        <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-blue-500 rounded-bl-xl -mb-1 -ml-1"></div>
                                        <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-blue-500 rounded-br-xl -mb-1 -mr-1"></div>
                                        
                                        <div class="absolute top-1/2 left-0 right-0 h-0.5 bg-red-500/50 animate-pulse"></div>
                                    </div>
                                </div>
                                
                                <div class="absolute bottom-20 left-0 right-0 text-center pointer-events-none">
                                    <div class="inline-block bg-black/60 backdrop-blur-md text-white px-6 py-2 rounded-full text-sm font-medium">
                                        Align QR code within frame
                                    </div>
                                </div>
                            </div>
                        </div>
                    `);
                    return;
                }
                
                // Expiry Date Selection Screen
                if (this.showingExpirySelection && this.pendingScan) {
                    const scan = this.pendingScan;
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    updateView(`
                        <div class="min-h-screen bg-slate-50 flex flex-col">
                            <div class="flex-1 p-4 sm:p-6 flex flex-col justify-center max-w-md lg:max-w-lg mx-auto w-full">
                                <div class="bg-white rounded-2xl sm:rounded-3xl shadow-xl shadow-slate-200 overflow-hidden">
                                    <div class="bg-blue-500 p-4 sm:p-6 text-white text-center">
                                        <div class="flex items-center justify-center gap-2 mb-2">
                                            <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                            </svg>
                                            <span class="font-bold text-sm sm:text-base">CONFIRM EXPIRY DATE</span>
                                        </div>
                                        <h2 class="text-lg sm:text-xl font-bold">Multiple Expiry Dates Found</h2>
                                        <p class="text-blue-100 text-xs sm:text-sm mt-1">Please select the correct expiry date for this item</p>
                                    </div>
                                    
                                    <div class="p-4 sm:p-6 space-y-4">
                                        <!-- Product Info -->
                                        <div class="text-center pb-4 border-b border-slate-100">
                                            <div class="inline-block bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-xs sm:text-sm font-bold mb-2">
                                                ${scan.stockCode}
                                            </div>
                                            <h3 class="text-base sm:text-lg font-medium text-slate-900 leading-tight mb-1">${scan.description}</h3>
                                            <div class="text-xs sm:text-sm text-slate-500">Batch: ${scan.batchNumber}</div>
                                        </div>
                                        
                                        <!-- Expiry Date Options -->
                                        <div class="space-y-2">
                                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">
                                                Select Expiry Date
                                            </label>
                                            ${scan.availableExpiryDates.map(expDate => {
                                                const exp = new Date(expDate);
                                                exp.setHours(0, 0, 0, 0);
                                                const isExpired = exp <= today;
                                                const displayDate = exp.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                                                
                                                return `
                                                    <button 
                                                        onclick="app.selectExpiryDate('${expDate}')"
                                                        class="w-full p-3 sm:p-4 border-2 ${isExpired ? 'border-red-200 bg-red-50 hover:border-red-400' : 'border-slate-200 bg-white hover:border-blue-400 hover:bg-blue-50'} rounded-xl transition-all text-left flex items-center justify-between"
                                                    >
                                                        <div class="flex items-center gap-3">
                                                            <div class="w-8 h-8 sm:w-10 sm:h-10 ${isExpired ? 'bg-red-100' : 'bg-blue-100'} rounded-full flex items-center justify-center">
                                                                <svg class="w-4 h-4 sm:w-5 sm:h-5 ${isExpired ? 'text-red-600' : 'text-blue-600'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                                                </svg>
                                                            </div>
                                                            <div>
                                                                <div class="font-bold text-sm sm:text-base ${isExpired ? 'text-red-700' : 'text-slate-900'}">${displayDate}</div>
                                                                ${isExpired ? '<div class="text-xs text-red-500 font-medium"> EXPIRED</div>' : ''}
                                                            </div>
                                                        </div>
                                                        <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                                        </svg>
                                                    </button>
                                                `;
                                            }).join('')}
                                        </div>
                                        
                                        <!-- Cancel Button -->
                                        <button 
                                            onclick="app.cancelExpirySelection()" 
                                            class="w-full mt-4 bg-slate-100 hover:bg-slate-200 text-slate-600 py-2.5 sm:py-3 rounded-xl text-sm sm:text-base font-bold transition-colors"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `);
                    return;
                }
                
                if (this.showingCaseEntry && this.currentScan) {
                    const scan = this.currentScan;
                    // Check if expired
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    let isExpired = false;
                    let expiryDisplay = '';
                    if (scan.expiryDate) {
                        const expiry = new Date(scan.expiryDate);
                        expiry.setHours(0, 0, 0, 0);
                        isExpired = expiry <= today;
                        expiryDisplay = expiry.toLocaleDateString();
                    }
                    updateView(`
                        <div class="min-h-screen bg-slate-50 flex flex-col">
                            <div class="flex-1 p-4 sm:p-6 flex flex-col justify-center max-w-md lg:max-w-lg mx-auto w-full">
                                <div class="bg-white rounded-2xl sm:rounded-3xl shadow-xl shadow-slate-200 overflow-hidden">
                                    <div class="${isExpired ? 'bg-red-600' : 'bg-blue-600'} p-4 sm:p-6 text-white text-center">
                                        ${isExpired ? `
                                            <div class="flex items-center justify-center gap-2 mb-2">
                                                <svg class="w-5 h-5 sm:w-6 sm:h-6 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                                </svg>
                                                <span class="font-bold text-sm sm:text-base">EXPIRED PRODUCT</span>
                                            </div>
                                        ` : ''}
                                        <h2 class="text-xl sm:text-2xl font-bold">Confirm Count</h2>
                                        <p class="${isExpired ? 'text-red-100' : 'text-blue-100'} text-xs sm:text-sm mt-1">Verify the physical stock count</p>
                                    </div>
                                    
                                    ${isExpired ? `
                                        <div class="bg-red-50 border-b border-red-100 p-4 flex items-center gap-3">
                                            <div class="flex-shrink-0 w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                                                <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                                </svg>
                                            </div>
                                            <div>
                                                <div class="font-bold text-red-700">Expired: ${expiryDisplay}</div>
                                                <div class="text-sm text-red-600">This item is past its expiry date</div>
                                            </div>
                                        </div>
                                    ` : (scan.expiryDate ? `
                                        <div class="bg-slate-50 border-b border-slate-100 p-3 flex items-center justify-center gap-2 text-sm text-slate-600">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                            </svg>
                                            <span>Expires: ${expiryDisplay}</span>
                                        </div>
                                    ` : '')}
                                    
                                    <div class="p-4 sm:p-6 space-y-4 sm:space-y-6">
                                        <!-- Product Info -->
                                        <div class="text-center">
                                            <div class="inline-block ${isExpired ? 'bg-red-50 text-red-700' : 'bg-blue-50 text-blue-700'} px-3 py-1 rounded-full text-xs sm:text-sm font-bold mb-2">
                                                ${scan.stockCode}
                                            </div>
                                            <h3 class="text-base sm:text-lg font-medium text-slate-900 leading-tight mb-1">${scan.description}</h3>
                                            ${scan.isRawMaterial ? `
                                                <div class="text-xs sm:text-sm text-slate-500">Batch: ${scan.batchNumber}</div>
                                                <div class="mt-1 inline-block px-2 py-0.5 text-xs font-bold ${scan.unitType === 'kg' ? 'bg-teal-100 text-teal-700' : 'bg-blue-100 text-blue-700'} rounded-full">
                                                    ${scan.unitType === 'kg' ? ' Measured in KG' : ' Counted in Units'}
                                                </div>
                                            ` : `
                                                <div class="text-xs sm:text-sm text-slate-500">Batch: ${scan.batchNumber}  Pallet: ${scan.palletNumber}</div>
                                            `}
                                        </div>

                                        <!-- Count Input -->
                                        <div class="bg-slate-50 rounded-xl sm:rounded-2xl p-4 sm:p-6 border border-slate-100">
                                            ${!scan.isRawMaterial ? `
                                                <div class="flex justify-between items-center mb-4">
                                                    <span class="text-xs sm:text-sm font-bold text-slate-500 uppercase tracking-wider">Expected</span>
                                                    <span class="text-xl sm:text-2xl font-bold text-slate-400">${scan.casesOnPallet}</span>
                                                </div>
                                            ` : ''}
                                            
                                            <div class="relative">
                                                <label class="block text-xs font-bold ${isExpired ? 'text-red-600' : 'text-blue-600'} uppercase tracking-wider mb-2">
                                                    ${scan.isRawMaterial ? (scan.unitType === 'kg' ? 'Quantity (KG)' : 'Quantity (Units)') : 'Actual Count'}
                                                </label>
                                                <input
                                                    type="number"
                                                    id="caseInput"
                                                    value="${scan.isRawMaterial ? '' : scan.casesOnPallet}"
                                                    min="0"
                                                    ${scan.unitType === 'kg' ? 'step="0.01"' : ''}
                                                    placeholder="${scan.isRawMaterial ? 'Enter ' + scan.unitType : ''}"
                                                    class="w-full px-4 py-3 sm:py-4 bg-white border-2 ${isExpired ? 'border-red-100 text-red-900 focus:border-red-600 focus:ring-red-50' : 'border-blue-100 text-blue-900 focus:border-blue-600 focus:ring-blue-50'} rounded-xl text-3xl sm:text-4xl font-black text-center focus:ring-4 outline-none transition-all"
                                                    autofocus
                                                    onclick="this.select()"
                                                />
                                                ${scan.isRawMaterial ? `
                                                    <div class="mt-2 text-center text-xs sm:text-sm text-slate-500">${scan.unitType === 'kg' ? 'Enter weight in kilograms' : 'Enter quantity in units'}</div>
                                                ` : ''}
                                            </div>
                                        </div>
                                        
                                        <!-- Actions -->
                                        <div class="grid grid-cols-2 gap-3 sm:gap-4 pt-2">
                                            <button onclick="app.cancelCaseEntry()" class="bg-white border-2 border-slate-200 text-slate-600 hover:bg-slate-50 py-3 sm:py-4 rounded-xl text-base sm:text-lg font-bold transition-colors">
                                                Cancel
                                            </button>
                                            <button onclick="app.submitCaseCount()" class="${isExpired ? 'bg-red-600 hover:bg-red-700 shadow-red-200' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200'} text-white py-3 sm:py-4 rounded-xl text-base sm:text-lg font-bold shadow-lg transition-all">
                                                ${isExpired ? 'Confirm (Expired)' : 'Confirm'}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `);
                    return;
                }
                
                if (this.showingProductDB) {
                    updateView(`
                        <div class="min-h-screen bg-slate-50 pb-24">
                            <div class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-20">
                                <div class="max-w-4xl mx-auto">
                                    <div class="flex items-center justify-between p-4">
                                        <div>
                                            <h1 class="text-lg sm:text-xl font-bold text-slate-900">Product Database</h1>
                                            <p class="text-xs sm:text-sm text-slate-500">${Object.keys(productDatabase).length} products ${productsLoadedFromDB ? '(from Supabase)' : '(cached)'}</p>
                                        </div>
                                        <button onclick="app.hideProductDatabase()" class="p-2 bg-slate-100 hover:bg-slate-200 rounded-full transition-colors">
                                            <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                            </svg>
                                        </button>
                                    </div>
                                    
                                    <div class="flex gap-2 p-4 pt-0">
                                        <button onclick="app.refreshProductsFromCloud()" class="flex-1 bg-blue-50 text-blue-600 hover:bg-blue-100 py-2.5 px-3 sm:px-4 rounded-xl text-xs sm:text-sm font-bold transition-colors flex items-center justify-center gap-1 sm:gap-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                            </svg>
                                            <span class="hidden sm:inline">Refresh</span>
                                            <span class="sm:hidden"></span>
                                        </button>
                                        <button onclick="app.uploadExcel()" class="flex-1 bg-blue-50 text-blue-600 hover:bg-blue-100 py-2.5 px-3 sm:px-4 rounded-xl text-xs sm:text-sm font-bold transition-colors flex items-center justify-center gap-1 sm:gap-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                            </svg>
                                            Import
                                        </button>
                                        <button onclick="app.exportProductDatabase()" class="flex-1 bg-emerald-50 text-emerald-600 hover:bg-emerald-100 py-2.5 px-3 sm:px-4 rounded-xl text-xs sm:text-sm font-bold transition-colors flex items-center justify-center gap-1 sm:gap-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                            </svg>
                                            Export
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="p-4 max-w-4xl mx-auto">
                                <div class="space-y-3 md:grid md:grid-cols-2 lg:grid-cols-3 md:gap-4 md:space-y-0">
                                ${Object.keys(productDatabase).length === 0 ? `
                                    <div class="md:col-span-2 lg:col-span-3 text-center py-16">
                                        <div class="w-16 h-16 sm:w-20 sm:h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <svg class="w-8 h-8 sm:w-10 sm:h-10 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                                            </svg>
                                        </div>
                                        <p class="text-lg font-medium text-slate-900">Database Empty</p>
                                        <p class="text-sm text-slate-500 mt-1">Import an Excel file or add products manually</p>
                                    </div>
                                ` : Object.entries(productDatabase).map(([batch, info]) => `
                                    <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100 hover-lift transition-all">
                                        <div class="flex items-center gap-3 mb-2">
                                            <span class="bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded font-mono font-bold">
                                                ${batch}
                                            </span>
                                            <span class="text-sm font-bold text-blue-600">${info.stockCode}</span>
                                        </div>
                                        <div class="text-slate-900 text-sm">${info.description}</div>
                                    </div>
                                `).join('')}
                                </div>
                            </div>
                            
                            <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-4 z-20">
                                <div class="max-w-4xl mx-auto space-y-3">
                                    <button onclick="app.addProduct()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 sm:py-3.5 rounded-xl text-base sm:text-lg font-bold shadow-lg shadow-blue-200 transition-all">
                                        + Add Product
                                    </button>
                                    ${Object.keys(productDatabase).length > 0 ? `
                                        <button onclick="app.clearDatabase()" class="w-full bg-white border border-red-200 text-red-600 hover:bg-red-50 py-2.5 sm:py-3 rounded-xl text-sm font-bold transition-colors">
                                            Clear Database
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `);
                    return;
                }
                
                if (this.showingRMProductDB) {
                    const rmCount = Object.keys(rawMaterialsDatabase).length;
                    let totalBatches = 0;
                    Object.values(rawMaterialsDatabase).forEach(rm => {
                        totalBatches += Object.keys(rm.batches || {}).length;
                    });
                    
                    updateView(`
                        <div class="min-h-screen bg-slate-50 pb-24">
                            <div class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-20">
                                <div class="max-w-4xl mx-auto">
                                    <div class="flex items-center justify-between p-4">
                                        <div>
                                            <h1 class="text-lg sm:text-xl font-bold text-slate-900">Raw Materials</h1>
                                            <p class="text-xs sm:text-sm text-slate-500">${rmCount} materials, ${totalBatches} batches ${rmProductsLoadedFromDB ? '(from Supabase)' : '(cached)'}</p>
                                        </div>
                                        <button onclick="app.hideProductDatabase()" class="p-2 bg-slate-100 hover:bg-slate-200 rounded-full transition-colors">
                                            <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="flex gap-2 p-4 pt-0">
                                    <button onclick="app.refreshProductsFromCloud()" class="flex-1 bg-blue-50 text-blue-600 hover:bg-blue-100 py-2.5 px-3 sm:px-4 rounded-xl text-xs sm:text-sm font-bold transition-colors flex items-center justify-center gap-1 sm:gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                        </svg>
                                        <span class="hidden sm:inline">Refresh</span>
                                        <span class="sm:hidden"></span>
                                    </button>
                                    <button onclick="app.uploadRMExcel()" class="flex-1 bg-teal-50 text-teal-600 hover:bg-teal-100 py-2.5 px-3 sm:px-4 rounded-xl text-xs sm:text-sm font-bold transition-colors flex items-center justify-center gap-1 sm:gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                        </svg>
                                        Import
                                    </button>
                                    <button onclick="app.exportRMDatabase()" class="flex-1 bg-emerald-50 text-emerald-600 hover:bg-emerald-100 py-2.5 px-3 sm:px-4 rounded-xl text-xs sm:text-sm font-bold transition-colors flex items-center justify-center gap-1 sm:gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                        </svg>
                                        Export
                                    </button>
                                </div>
                                </div>
                            </div>
                            
                            <div class="p-4 max-w-4xl mx-auto">
                                <div class="space-y-3 md:grid md:grid-cols-2 lg:grid-cols-3 md:gap-4 md:space-y-0">
                                ${rmCount === 0 ? `
                                    <div class="md:col-span-2 lg:col-span-3 text-center py-16">
                                        <div class="w-16 h-16 sm:w-20 sm:h-20 bg-teal-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <svg class="w-8 h-8 sm:w-10 sm:h-10 text-teal-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                                            </svg>
                                        </div>
                                        <p class="text-lg font-medium text-slate-900">No Raw Materials</p>
                                        <p class="text-sm text-slate-500 mt-1">Import an Excel file or add materials manually</p>
                                    </div>
                                ` : Object.entries(rawMaterialsDatabase).map(([stockCode, info]) => `
                                    <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100 hover-lift transition-all">
                                        <div class="flex items-center gap-3 mb-2">
                                            <span class="bg-teal-100 text-teal-700 text-xs px-2 py-1 rounded font-mono font-bold">
                                                ${stockCode}
                                            </span>
                                            <span class="text-xs text-slate-400">${Object.keys(info.batches || {}).length} batches</span>
                                        </div>
                                        <div class="text-slate-900 text-sm font-medium mb-2">${info.description}</div>
                                        ${Object.keys(info.batches || {}).length > 0 ? `
                                            <div class="flex flex-wrap gap-2 mt-2">
                                                ${Object.entries(info.batches).map(([batch, batchInfo]) => `
                                                    <span class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded ${batchInfo.expiryDate && new Date(batchInfo.expiryDate) < new Date() ? 'bg-red-100 text-red-600' : ''}">
                                                        ${batch}${batchInfo.expiryDate ? '  ' + batchInfo.expiryDate : ''}
                                                    </span>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                                </div>
                            </div>
                            
                            <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-4 z-20">
                                <div class="max-w-4xl mx-auto space-y-3">
                                    <button onclick="app.addRawMaterial()" class="w-full bg-teal-600 hover:bg-teal-700 text-white py-3 sm:py-3.5 rounded-xl text-base sm:text-lg font-bold shadow-lg shadow-teal-200 transition-all">
                                        + Add Raw Material
                                    </button>
                                    ${rmCount > 0 ? `
                                        <button onclick="app.clearRMDatabase()" class="w-full bg-white border border-red-200 text-red-600 hover:bg-red-50 py-2.5 sm:py-3 rounded-xl text-sm font-bold transition-colors">
                                            Clear Database
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `);
                    return;
                }

                // Session History Screen
                if (this.showingSessionHistory) {
                    const groupedSessions = {};
                    const liveSessions = [];
                    const historicalSessions = [];
                    const today = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD format
                    
                    this.historySessions.forEach(session => {
                        const date = session.date || 'Unknown';
                        if (!groupedSessions[date]) groupedSessions[date] = [];
                        groupedSessions[date].push(session);
                        
                        // Separate live (active) from historical
                        // A session is live if its status is 'active'
                        if (session.status === 'active') {
                            liveSessions.push(session);
                        } else {
                            historicalSessions.push(session);
                        }
                    });
                    
                    // Group historical sessions by date
                    const groupedHistorical = {};
                    historicalSessions.forEach(session => {
                        const date = session.date || 'Unknown';
                        if (!groupedHistorical[date]) groupedHistorical[date] = [];
                        groupedHistorical[date].push(session);
                    });
                    
                    updateView(`
                        <div class="min-h-screen bg-slate-50 p-4">
                            <div class="max-w-2xl lg:max-w-4xl mx-auto">
                                <!-- Header -->
                                <div class="bg-white rounded-2xl shadow-lg shadow-slate-200 overflow-hidden mb-4">
                                    <div class="p-4 border-b border-slate-100 flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 sm:w-10 sm:h-10 bg-blue-500 rounded-xl flex items-center justify-center">
                                                <svg class="w-4 h-4 sm:w-5 sm:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                            </div>
                                            <div>
                                                <h2 class="text-base sm:text-lg font-bold text-slate-900">Sessions</h2>
                                                <p class="text-xs text-slate-500">${liveSessions.length} live, ${historicalSessions.length} historical</p>
                                            </div>
                                        </div>
                                        <button onclick="app.hideSessionHistory()" class="p-2 bg-slate-50 hover:bg-slate-100 rounded-full transition-colors">
                                            <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                            </svg>
                                        </button>
                                    </div>
                                    
                                    ${this.selectedHistorySession ? `
                                        <!-- Selected Session Details -->
                                        <div class="p-4 bg-blue-50 border-b border-blue-100">
                                            <div class="flex items-center justify-between mb-3">
                                                <div>
                                                    <div class="flex items-center gap-2">
                                                        <span class="${this.selectedHistorySession.sessionType === 'RM' ? 'bg-teal-100 text-teal-700' : 'bg-blue-100 text-blue-700'} text-xs font-bold px-2 py-0.5 rounded-full">
                                                            ${this.selectedHistorySession.sessionType === 'RM' ? 'Raw Materials' : 'Finished Products'}
                                                        </span>
                                                        <span class="text-xs text-slate-500">${this.selectedHistorySession.date}</span>
                                                    </div>
                                                    <p class="text-sm text-slate-600 mt-1">Session: ${this.selectedHistorySession.id.slice(-8)}</p>
                                                    <p class="text-xs text-slate-500">Device: ${this.selectedHistorySession.device}</p>
                                                </div>
                                                <button onclick="app.exportHistorySession()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700 transition-colors flex items-center gap-2">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                    </svg>
                                                    Export
                                                </button>
                                            </div>
                                            <div class="text-sm text-blue-700 font-medium">${this.historyLoading ? '<span class="inline-flex items-center gap-1"><svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>Loading...</span>' : `${this.historyScans.length} scan(s)`}</div>
                                        </div>
                                        
                                        <!-- Scans List -->
                                        <div class="max-h-80 overflow-y-auto">
                                            ${this.historyLoading ? `
                                                <div class="p-8 text-center">
                                                    <div class="inline-flex items-center gap-3">
                                                        <svg class="w-5 h-5 animate-spin text-blue-500" fill="none" viewBox="0 0 24 24">
                                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                        </svg>
                                                        <span class="text-slate-500 font-medium">Loading scans...</span>
                                                    </div>
                                                </div>
                                            ` : this.historyScans.length > 0 ? this.historyScans.map((scan, idx) => `
                                                <div class="p-3 border-b border-slate-100 hover:bg-slate-50">
                                                    <div class="flex items-center justify-between">
                                                        <div class="flex-1">
                                                            <div class="flex items-center gap-2">
                                                                <span class="font-bold text-sm text-slate-800">${scan.stockCode}</span>
                                                                <span class="text-xs text-slate-400">#${scan.batchNumber}</span>
                                                            </div>
                                                            <p class="text-xs text-slate-500 truncate">${scan.description || 'No description'}</p>
                                                            <div class="flex items-center gap-2 mt-1 text-xs text-slate-400">
                                                                ${scan.location ? `<span> ${scan.location}</span>` : ''}
                                                                ${scan.expiryDate ? `<span> ${scan.expiryDate}</span>` : ''}
                                                            </div>
                                                        </div>
                                                        <div class="text-right">
                                                            <div class="font-bold text-lg ${this.selectedHistorySession.sessionType === 'RM' ? 'text-teal-600' : 'text-blue-600'}">
                                                                ${scan.cases}
                                                            </div>
                                                            <div class="text-xs text-slate-500">${scan.unitType || 'units'}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('') : `
                                                <div class="p-8 text-center text-slate-400">
                                                    <p>No scans in this session</p>
                                                </div>
                                            `}
                                        </div>
                                        
                                        <div class="p-4 border-t border-slate-100">
                                            <button onclick="app.selectedHistorySession = null; app.historyScans = []; app.historyLoading = false; app.render();" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 py-2 rounded-lg text-sm font-bold transition-colors">
                                                 Back to Sessions
                                            </button>
                                        </div>
                                    ` : `
                                        <!-- Sessions List -->
                                        <div class="max-h-96 overflow-y-auto">
                                            ${liveSessions.length > 0 ? `
                                                <!-- Live Sessions -->
                                                <div class="border-b border-slate-100">
                                                    <div class="px-4 py-2 bg-emerald-50 text-xs font-bold text-emerald-700 uppercase tracking-wider flex items-center gap-2">
                                                        <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                                                        Live Sessions
                                                    </div>
                                                    ${liveSessions.map(session => `
                                                        <button onclick="app.loadSessionHistory('${session.id}')" class="w-full p-4 hover:bg-slate-50 transition-colors text-left border-b border-slate-50 last:border-0">
                                                            <div class="flex items-center justify-between">
                                                                <div class="flex items-center gap-3">
                                                                    <div class="w-10 h-10 ${session.sessionType === 'RM' ? 'bg-teal-100' : 'bg-blue-100'} rounded-xl flex items-center justify-center">
                                                                        <span class="${session.sessionType === 'RM' ? 'text-teal-600' : 'text-blue-600'} font-bold text-xs">${session.sessionType}</span>
                                                                    </div>
                                                                    <div>
                                                                        <div class="flex items-center gap-2">
                                                                            <span class="font-bold text-sm text-slate-800">${session.sessionType === 'RM' ? 'Raw Materials' : 'Finished Products'}</span>
                                                                            <span class="bg-emerald-100 text-emerald-700 text-xs font-medium px-2 py-0.5 rounded-full flex items-center gap-1">
                                                                                <div class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></div>
                                                                                live
                                                                            </span>
                                                                        </div>
                                                                        <div class="text-xs text-slate-500 mt-0.5">
                                                                            Session: ${session.id.slice(-8)}  ${session.device || 'Unknown device'}
                                                                        </div>
                                                                        ${session.startTime ? `<div class="text-xs text-slate-400">${session.startTime}</div>` : ''}
                                                                    </div>
                                                                </div>
                                                                <svg class="w-5 h-5 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                                                </svg>
                                                            </div>
                                                        </button>
                                                    `).join('')}
                                                </div>
                                            ` : ''}
                                            
                                            ${Object.keys(groupedHistorical).length > 0 ? Object.entries(groupedHistorical).map(([date, sessions]) => `
                                                <div class="border-b border-slate-100">
                                                    <div class="px-4 py-2 bg-slate-50 text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                        ${date}
                                                    </div>
                                                    ${sessions.map(session => `
                                                        <button onclick="app.loadSessionHistory('${session.id}')" class="w-full p-4 hover:bg-slate-50 transition-colors text-left border-b border-slate-50 last:border-0">
                                                            <div class="flex items-center justify-between">
                                                                <div class="flex items-center gap-3">
                                                                    <div class="w-10 h-10 ${session.sessionType === 'RM' ? 'bg-teal-100' : 'bg-blue-100'} rounded-xl flex items-center justify-center">
                                                                        <span class="${session.sessionType === 'RM' ? 'text-teal-600' : 'text-blue-600'} font-bold text-xs">${session.sessionType}</span>
                                                                    </div>
                                                                    <div>
                                                                        <div class="flex items-center gap-2">
                                                                            <span class="font-bold text-sm text-slate-800">${session.sessionType === 'RM' ? 'Raw Materials' : 'Finished Products'}</span>
                                                                            <span class="${session.status === 'completed' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-600'} text-xs font-medium px-2 py-0.5 rounded-full">
                                                                                ${session.status || 'active'}
                                                                            </span>
                                                                        </div>
                                                                        <div class="text-xs text-slate-500 mt-0.5">
                                                                            Session: ${session.id.slice(-8)}  ${session.device || 'Unknown device'}
                                                                        </div>
                                                                        ${session.startTime ? `<div class="text-xs text-slate-400">${session.startTime}</div>` : ''}
                                                                    </div>
                                                                </div>
                                                                <svg class="w-5 h-5 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                                                </svg>
                                                            </div>
                                                        </button>
                                                    `).join('')}
                                                </div>
                                            `).join('') : (liveSessions.length === 0 ? `
                                                <div class="p-8 text-center text-slate-400">
                                                    <svg class="w-12 h-12 mx-auto mb-3 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                    </svg>
                                                    <p class="font-medium">No sessions found</p>
                                                    <p class="text-sm">Complete a stock count to see it here</p>
                                                </div>
                                            ` : '')}
                                        </div>
                                    `}
                                </div>
                                
                                <button onclick="app.hideSessionHistory()" class="w-full bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 py-3 rounded-xl text-sm font-bold transition-colors">
                                    Close
                                </button>
                            </div>
                        </div>
                    `);
                    return;
                }

                if (this.showingSettings) {
                    updateView(`
                        <div class="min-h-screen bg-slate-50 p-4 flex items-start sm:items-center justify-center pt-8 sm:pt-4">
                            <div class="max-w-md md:max-w-lg lg:max-w-xl w-full bg-white rounded-3xl shadow-xl shadow-slate-200 overflow-hidden">
                                <div class="p-4 sm:p-6 border-b border-slate-100 flex items-center justify-between">
                                    <h2 class="text-lg sm:text-xl font-bold text-slate-900">Settings</h2>
                                    <button onclick="app.hideSettings()" class="p-2 bg-slate-50 hover:bg-slate-100 rounded-full transition-colors">
                                        <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                                
                                <div class="p-4 sm:p-6 space-y-5 sm:space-y-6 max-h-[70vh] overflow-y-auto">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">
                                            Device ID
                                        </label>
                                        <div class="flex items-center gap-2 bg-slate-50 px-3 sm:px-4 py-2.5 sm:py-3 rounded-xl border border-slate-200">
                                            <svg class="w-4 h-4 sm:w-5 sm:h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                            </svg>
                                            <code class="text-xs sm:text-sm font-mono text-slate-600 flex-1 truncate">${DEVICE_ID}</code>
                                        </div>
                                    </div>
                                    
                                    <!-- Location Scanning Toggle -->
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">
                                            Location Scanning
                                        </label>
                                        <div class="px-4 py-4 border rounded-xl border-slate-200 bg-slate-50">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center gap-3">
                                                    <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                    </svg>
                                                    <div>
                                                        <div class="font-bold text-sm text-slate-800">Track Location</div>
                                                        <div class="text-xs text-slate-500">Rack, Floor, Bin, etc.</div>
                                                    </div>
                                                </div>
                                                <button 
                                                    onclick="app.toggleLocationScanning()"
                                                    class="relative w-12 h-7 rounded-full transition-colors ${this.sessionSettings.locationScanningEnabled ? 'bg-blue-600' : 'bg-slate-300'}"
                                                >
                                                    <span class="absolute top-1 ${this.sessionSettings.locationScanningEnabled ? 'left-6' : 'left-1'} w-5 h-5 bg-white rounded-full shadow transition-all"></span>
                                                </button>
                                            </div>
                                            
                                            ${this.sessionSettings.locationScanningEnabled ? `
                                                <div class="mt-4 pt-4 border-t border-slate-200">
                                                    <label class="block text-xs font-medium text-slate-500 mb-2">Current Location</label>
                                                    <div class="flex gap-2">
                                                        <input 
                                                            type="text" 
                                                            id="locationInput"
                                                            value="${this.sessionSettings.currentLocation || ''}"
                                                            placeholder="e.g., Rack A1, Floor 2"
                                                            class="flex-1 px-3 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none"
                                                        />
                                                        <button 
                                                            onclick="app.setLocation(document.getElementById('locationInput').value)"
                                                            class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700 transition-colors"
                                                        >
                                                            Set
                                                        </button>
                                                    </div>
                                                    <div class="grid grid-cols-3 gap-2 mt-3">
                                                        <div>
                                                            <label class="text-[10px] uppercase tracking-wide text-slate-400 font-bold">Site</label>
                                                            <input 
                                                                type="text"
                                                                value="${this.sessionSettings.site || ''}"
                                                                oninput="app.updateLocationHierarchy('site', this.value)"
                                                                placeholder="Plant"
                                                                class="w-full mt-1 px-3 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none"
                                                            />
                                                        </div>
                                                        <div>
                                                            <label class="text-[10px] uppercase tracking-wide text-slate-400 font-bold">Aisle</label>
                                                            <input 
                                                                type="text"
                                                                value="${this.sessionSettings.aisle || ''}"
                                                                oninput="app.updateLocationHierarchy('aisle', this.value)"
                                                                placeholder="Aisle"
                                                                class="w-full mt-1 px-3 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none"
                                                            />
                                                        </div>
                                                        <div>
                                                            <label class="text-[10px] uppercase tracking-wide text-slate-400 font-bold">Rack</label>
                                                            <input 
                                                                type="text"
                                                                value="${this.sessionSettings.rack || ''}"
                                                                oninput="app.updateLocationHierarchy('rack', this.value)"
                                                                placeholder="Rack"
                                                                class="w-full mt-1 px-3 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none"
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">
                                            Connection Status
                                        </label>
                                        ${(() => {
                                            const mode = this.useNeonDB ? 'netlify' : (this.usingSupabaseDB ? 'supabase' : 'offline');
                                            const configs = {
                                                netlify: {
                                                    border: 'border-emerald-200 bg-emerald-50',
                                                    dot: 'bg-emerald-500',
                                                    title: 'Connected to Neon DB',
                                                    titleClass: 'text-emerald-800',
                                                    subtitle: 'Data is syncing through Netlify Functions',
                                                    subtitleClass: 'text-emerald-600',
                                                    note: null,
                                                    noteClass: ''
                                                },
                                                supabase: {
                                                    border: 'border-blue-200 bg-blue-50',
                                                    dot: 'bg-blue-500',
                                                    title: 'Connected to Supabase',
                                                    titleClass: 'text-blue-800',
                                                    subtitle: 'All scans sync directly to Supabase Postgres',
                                                    subtitleClass: 'text-blue-600',
                                                    note: 'Session heartbeats, duplicate checks, and exports are using Supabase only.',
                                                    noteClass: 'text-blue-500'
                                                },
                                                offline: {
                                                    border: 'border-slate-200 bg-slate-50',
                                                    dot: 'bg-slate-400',
                                                    title: 'Offline Mode',
                                                    titleClass: 'text-slate-700',
                                                    subtitle: 'Data stored locally on this device',
                                                    subtitleClass: 'text-slate-500',
                                                    note: 'Reconnect to sync with Supabase automatically.',
                                                    noteClass: 'text-slate-500'
                                                }
                                            };
                                            const cfg = configs[mode];
                                            return `
                                                <div class="px-4 py-4 border rounded-xl ${cfg.border}">
                                                    <div class="flex items-center gap-3">
                                                        <div class="w-3 h-3 rounded-full ${cfg.dot}"></div>
                                                        <div>
                                                            <div class="font-bold text-sm ${cfg.titleClass}">${cfg.title}</div>
                                                            <div class="text-xs mt-0.5 ${cfg.subtitleClass}">${cfg.subtitle}</div>
                                                        </div>
                                                    </div>
                                                    ${cfg.note ? `<div class="mt-3 text-xs ${cfg.noteClass}">${cfg.note}</div>` : ''}
                                                </div>
                                            `;
                                        })()}
                                    </div>
                                    
                                    <div class="pt-2 space-y-3">
                                        <button onclick="app.testConnection()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl text-sm font-bold shadow-lg shadow-blue-100 transition-all">
                                             Test Connection
                                        </button>
                                        
                                        <button onclick="app.hideSettings()" class="w-full bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 py-3 rounded-xl text-sm font-bold transition-colors">
                                            Close
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `);
                    return;
                }
                
                // Main screen
                const userName = getUserName();
                updateView(`
                    <div class="min-h-screen bg-slate-50 pb-24">
                        <!-- Sticky Header -->
                        <div class="sticky top-0 z-30 bg-white/80 backdrop-blur-md border-b border-slate-200 px-4 py-3 shadow-sm">
                            <div class="max-w-4xl mx-auto flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 sm:w-12 sm:h-12 ${this.activeStockTake?.sessionType === 'RM' ? 'bg-teal-600' : 'bg-blue-600'} rounded-xl flex items-center justify-center shadow-md ${this.activeStockTake?.sessionType === 'RM' ? 'shadow-teal-200' : 'shadow-blue-200'}">
                                        <span class="text-white font-bold text-lg sm:text-xl">${userName.charAt(0).toUpperCase()}</span>
                                    </div>
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <h1 class="text-sm sm:text-base font-bold text-slate-900 leading-tight">${this.activeStockTake?.sessionType === 'RM' ? 'Raw Materials' : 'Finished Products'}</h1>
                                            <span class="${this.activeStockTake?.sessionType === 'RM' ? 'bg-teal-100 text-teal-700' : 'bg-blue-100 text-blue-700'} text-xs font-bold px-2 py-0.5 rounded-full">
                                                #${this.activeStockTake?.sessionNumber || 1}
                                            </span>
                                        </div>
                                        <div class="flex items-center gap-2 mt-0.5">
                                            <p class="text-xs text-slate-500 font-medium">${this.currentTakeDate}</p>
                                            ${(() => {
                                                const session = this.activeStockTake?.id ? getSessionById(this.currentTakeDate, this.activeStockTake.id) : null;
                                                if (session?.devices && session.devices.length > 0) {
                                                    const now = Date.now();
                                                    const activeDevices = session.devices.filter(d => d.status === 'active');
                                                    const staleDevices = activeDevices.filter(d => {
                                                        if (!d.lastSeen) return false;
                                                        const last = new Date(d.lastSeen).getTime();
                                                        return now - last > HEARTBEAT_GRACE_MS;
                                                    });
                                                    const liveActive = activeDevices.length - staleDevices.length;
                                                    const completedCount = session.devices.filter(d => d.status === 'completed').length;
                                                    return `
                                                        <span class="text-xs text-slate-400"></span>
                                                        <span class="text-xs text-emerald-600 font-medium flex items-center gap-1">
                                                            <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></span>
                                                            ${liveActive} active${completedCount > 0 ? `, ${completedCount} done` : ''}
                                                        </span>
                                                        ${staleDevices.length > 0 ? `
                                                            <span class="text-xs text-red-500 font-medium flex items-center gap-1">
                                                                <span class="w-1.5 h-1.5 bg-red-500 rounded-full"></span>
                                                                ${staleDevices.length} idle
                                                            </span>
                                                        ` : ''}
                                                    `;
                                                }
                                                return '';
                                            })()}
                                            <span class="text-xs font-medium flex items-center gap-1 ${this.isOfflineMode() ? 'text-slate-500' : 'text-emerald-600'}">
                                                <span class="w-1.5 h-1.5 rounded-full ${this.isOfflineMode() ? 'bg-slate-400' : 'bg-emerald-500'} animate-pulse"></span>
                                                ${this.isOfflineMode() ? 'Offline cache' : 'Online'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="app.showProductDatabase()" class="p-2 text-slate-600 hover:bg-slate-100 rounded-xl transition-colors" title="Products">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/>
                                        </svg>
                                    </button>
                                    <button onclick="app.goHome()" class="p-2 text-slate-600 hover:bg-slate-100 rounded-xl transition-colors" title="Back to Home">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Bar -->
                        <div class="px-4 py-4 max-w-4xl mx-auto">
                            <div class="bg-white rounded-2xl p-4 sm:p-6 shadow-sm border border-slate-100">
                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                    <div>
                                        <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Total Scanned</div>
                                        <div class="text-3xl sm:text-4xl font-black text-slate-900">${this.scans.length}</div>
                                    </div>
                                </div>
                                ${(() => {
                                    const today = new Date();
                                    today.setHours(0, 0, 0, 0);
                                    const expiredCount = this.scans.filter(s => {
                                        if (!s.expiryDate) return false;
                                        const exp = new Date(s.expiryDate);
                                        exp.setHours(0, 0, 0, 0);
                                        return exp <= today;
                                    }).length;
                                    return expiredCount > 0 ? `
                                        <div class="mt-3 flex items-center gap-2 p-2 bg-red-50 rounded-lg border border-red-100">
                                            <div class="flex-shrink-0 w-8 h-8 bg-red-500 rounded-full flex items-center justify-center">
                                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                                </svg>
                                            </div>
                                            <div>
                                                <div class="text-sm font-bold text-red-700">${expiredCount} Expired Item${expiredCount > 1 ? 's' : ''}</div>
                                                <div class="text-xs text-red-500">These items are past their expiry date</div>
                                            </div>
                                        </div>
                                    ` : '';
                                })()}
                            </div>
                            
                            ${this.useNeonDB ? `
                                <div class="mt-3 flex items-center justify-center gap-2 text-xs font-medium text-emerald-600 bg-emerald-50/50 py-1.5 rounded-lg border border-emerald-100/50">
                                    <div class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></div>
                                    <span>Live Sync Active</span>
                                </div>
                            ` : ''}
                            
                            ${this.sessionSettings.locationScanningEnabled ? `
                                <button onclick="app.promptForLocation()" class="mt-3 w-full flex items-center justify-center gap-2 text-xs font-medium ${this.sessionSettings.currentLocation ? 'text-blue-600 bg-blue-50/50 border-blue-100/50' : 'text-slate-500 bg-slate-50/50 border-slate-200/50'} py-2 rounded-lg border">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    </svg>
                                    <span>${[this.sessionSettings.site, this.sessionSettings.aisle, this.sessionSettings.rack].filter(Boolean).join('  ') || this.sessionSettings.currentLocation || 'Tap to set location'}</span>
                                </button>
                            ` : ''}
                        </div>

                        <!-- List -->
                        <div class="px-4 max-w-4xl mx-auto">
                            <div class="space-y-3 md:grid md:grid-cols-2 lg:grid-cols-3 md:gap-4 md:space-y-0">
                            ${this.scans.length === 0 ? `
                                <div class="md:col-span-2 lg:col-span-3 text-center py-20">
                                    <div class="w-24 h-24 sm:w-32 sm:h-32 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                        <svg class="w-10 h-10 sm:w-14 sm:h-14 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                                        </svg>
                                    </div>
                                    <h3 class="text-lg sm:text-xl font-bold text-slate-900">Ready to Scan</h3>
                                    <p class="text-slate-500 mt-1 text-sm sm:text-base">Tap the button below to start counting</p>
                                </div>
                            ` : this.scans.map(scan => {
                                // Check if expired
                                const today = new Date();
                                today.setHours(0, 0, 0, 0);
                                let isExpired = false;
                                let expiryDisplay = '';
                                if (scan.expiryDate) {
                                    const expiry = new Date(scan.expiryDate);
                                    expiry.setHours(0, 0, 0, 0);
                                    isExpired = expiry <= today;
                                    expiryDisplay = expiry.toLocaleDateString();
                                }
                                const borderColor = isExpired ? 'bg-red-500' : (scan.actualCases !== scan.casesOnPallet ? 'bg-yellow-500' : 'bg-emerald-500');
                                return `
                                <div class="bg-white rounded-2xl p-4 shadow-sm border ${isExpired ? 'border-red-200 bg-red-50' : 'border-slate-100'} relative overflow-hidden group hover-lift transition-all">
                                    <div class="absolute top-0 left-0 w-1 h-full ${borderColor}"></div>
                                    <div class="pl-3 flex items-start justify-between">
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-2 mb-1 flex-wrap">
                                                <span class="font-mono text-xs font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded">
                                                    ${scan.batchNumber || 'N/A'}
                                                </span>
                                                <span class="text-sm font-bold ${this.activeStockTake?.sessionType === 'RM' ? 'text-teal-600' : 'text-blue-600'} truncate">${scan.stockCode}</span>
                                                ${isExpired ? `
                                                    <span class="px-2 py-0.5 text-xs font-bold bg-red-500 text-white rounded-full animate-pulse">
                                                        EXPIRED
                                                    </span>
                                                ` : ''}
                                            </div>
                                            
                                            <div class="text-slate-900 font-medium text-sm mb-3 line-clamp-2">${scan.description}</div>
                                            
                                            <div class="flex items-center gap-3 text-xs text-slate-500 flex-wrap">
                                                ${scan.sessionType !== 'RM' && scan.palletNumber ? `
                                                <div class="flex items-center gap-1">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                                    </svg>
                                                    <span>Pallet ${scan.palletNumber}</span>
                                                </div>
                                                ` : ''}
                                                ${scan.location ? `
                                                    <div class="flex items-center gap-1 text-blue-600">
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                                        </svg>
                                                        <span>${scan.location}</span>
                                                    </div>
                                                ` : ''}
                                                <div class="flex items-center gap-1">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                                    </svg>
                                                    <span>${scan.scannedBy || 'Unknown'}</span>
                                                </div>
                                                <div class="flex items-center gap-1">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                    </svg>
                                                    <span>${scan.time}</span>
                                                </div>
                                                ${expiryDisplay ? `
                                                    <div class="flex items-center gap-1 ${isExpired ? 'text-red-600 font-bold' : 'text-slate-500'}">
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                                        </svg>
                                                        <span>Exp: ${expiryDisplay}</span>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                        
                                        <div class="flex flex-col items-end gap-3 ml-3">
                                            <div class="text-right">
                                                <div class="text-2xl font-black ${isExpired ? 'text-red-600' : (scan.actualCases !== scan.casesOnPallet ? 'text-yellow-600' : 'text-emerald-600')}">
                                                    ${scan.actualCases}
                                                </div>
                                                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">${scan.unitType === 'kg' ? 'KG' : (scan.unitType === 'units' ? 'UN' : 'Cases')}</div>
                                            </div>
                                            
                                            <button onclick="app.deleteScan('${scan.id}')" class="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                            }).join('')}
                            </div>
                        </div>

                        <!-- Floating Scan Button - Bottom Right -->
                        <button onclick="app.startScanning()" class="fixed bottom-6 right-6 w-16 h-16 ${this.activeStockTake?.sessionType === 'RM' ? 'bg-teal-600 hover:bg-teal-700 shadow-teal-200' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200'} active:scale-95 text-white rounded-full shadow-xl z-40 flex items-center justify-center transition-all">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                            </svg>
                        </button>
                    </div>
                `);
            }
        }

        const app = new ScannerApp();
        window.app = app;

        window.addEventListener('online', () => {
            if (window.app?.handleConnectivityChange) {
                window.app.handleConnectivityChange(true);
            }
        });

        window.addEventListener('offline', () => {
            if (window.app?.handleConnectivityChange) {
                window.app.handleConnectivityChange(false);
            }
        });
    </script>
</body>
</html>